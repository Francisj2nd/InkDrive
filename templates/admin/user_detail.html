{% extends "admin/base.html" %}

{% block title %}{{ user.name }} - User Details - InkDrive Admin{% endblock %}
{% block page_title %}User Details{% endblock %}
{% block page_description %}Detailed information for {{ user.name }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <a href="{{ url_for('admin.users') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Users
        </a>
    </div>
</div>

<div class="row">
     User Information 
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">User Information</h6>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    {% if user.profile_picture %}
                    <img src="{{ user.profile_picture }}" class="rounded-circle" width="80" height="80">
                    {% else %}
                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center mx-auto" style="width: 80px; height: 80px;">
                        <span class="text-white h3">{{ user.name[0].upper() }}</span>
                    </div>
                    {% endif %}
                </div>
                
                <table class="table table-sm table-borderless">
                    <tr>
                        <td><strong>Name:</strong></td>
                        <td>{{ user.name }}</td>
                    </tr>
                    <tr>
                        <td><strong>Email:</strong></td>
                        <td>{{ user.email }}</td>
                    </tr>
                    <tr>
                        <td><strong>Status:</strong></td>
                        <td>
                            <span class="badge bg-{{ 'success' if user.is_active else 'secondary' }}">
                                {{ 'Active' if user.is_active else 'Inactive' }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Verified:</strong></td>
                        <td>
                            <span class="badge bg-{{ 'success' if user.is_verified else 'warning' }}">
                                {{ 'Yes' if user.is_verified else 'No' }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Account Type:</strong></td>
                        <td>
                            {% if user.google_id %}
                            <i class="fab fa-google text-danger me-1"></i>Google
                            {% else %}
                            <i class="fas fa-envelope text-primary me-1"></i>Email
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Theme:</strong></td>
                        <td>{{ user.theme_preference.title() }}</td>
                    </tr>
                    <tr>
                        <td><strong>Joined:</strong></td>
                        <td>{{ user.created_at.strftime('%B %d, %Y') if user.created_at else 'N/A' }}</td>
                    </tr>
                    <tr>
                        <td><strong>Last Login:</strong></td>
                        <td>{{ user.last_login.strftime('%B %d, %Y at %I:%M %p') if user.last_login else 'Never' }}</td>
                    </tr>
                </table>

                <div class="d-grid gap-2 mt-3">
                    <button class="btn btn-warning btn-sm" onclick="resetUserLimits({{ user.id }}, '{{ user.name }}')">
                        <i class="fas fa-redo me-2"></i>Reset Monthly Limits
                    </button>
                    <button class="btn btn-{{ 'secondary' if user.is_active else 'success' }} btn-sm" 
                            onclick="toggleUserActive({{ user.id }}, '{{ user.name }}', {{ user.is_active|lower }})">
                        <i class="fas fa-{{ 'pause' if user.is_active else 'play' }} me-2"></i>
                        {{ 'Deactivate' if user.is_active else 'Activate' }} User
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteUser({{ user.id }}, '{{ user.name }}', '{{ user.email }}')">
                        <i class="fas fa-trash me-2"></i>Delete User
                    </button>
                </div>
            </div>
        </div>
    </div>

     User Statistics 
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">Usage Statistics</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 text-center">
                        <div class="h4 mb-0 text-primary">{{ user_stats.total_content_items }}</div>
                        <div class="text-xs text-uppercase">Total Content</div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="h4 mb-0 text-success">{{ "{:,}".format(user_stats.total_words) }}</div>
                        <div class="text-xs text-uppercase">Total Words</div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="h4 mb-0 text-info">{{ user_stats.total_views }}</div>
                        <div class="text-xs text-uppercase">Total Views</div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="h4 mb-0 text-warning">{{ user_stats.total_downloads }}</div>
                        <div class="text-xs text-uppercase">Total Downloads</div>
                    </div>
                </div>
                
                <hr>
                
                <div class="row">
                    <div class="col-md-6 text-center">
                        <div class="h5 mb-0 text-primary">{{ "{:,}".format(user_stats.words_this_month) }}</div>
                        <div class="text-xs text-uppercase">Words This Month</div>
                    </div>
                    <div class="col-md-6 text-center">
                        <div class="h5 mb-0 text-success">{{ user_stats.downloads_this_month }}</div>
                        <div class="text-xs text-uppercase">Downloads This Month</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
     Recent Content
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">Recent Content ({{ content_items|length }})</h6>
            </div>
            <div class="card-body">
                {% if content_items %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Words</th>
                                <th>Views</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for content in content_items %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('admin.content_detail', content_id=content.id) }}" class="text-decoration-none">
                                        {{ content.title[:40] }}{% if content.title|length > 40 %}...{% endif %}
                                    </a>
                                </td>
                                <td>{{ "{:,}".format(content.word_count or 0) }}</td>
                                <td>{{ content.view_count or 0 }}</td>
                                <td>
                                    <span class="badge bg-{{ 'success' if content.is_public else 'secondary' }}">
                                        {{ 'Published' if content.is_public else 'Draft' }}
                                    </span>
                                </td>
                                <td>{{ content.created_at.strftime('%m/%d/%Y') if content.created_at else 'N/A' }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('admin.content_detail', content_id=content.id) }}" class="btn btn-outline-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <button class="btn btn-outline-danger" onclick="deleteContent({{ content.id }}, '{{ content.title[:30] }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center">No content found.</p>
                {% endif %}
            </div>
        </div>
    </div>

     Chat Sessions 
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">Recent Chat Sessions ({{ chat_sessions|length }})</h6>
            </div>
            <div class="card-body">
                {% if chat_sessions %}
                <div class="list-group list-group-flush">
                    {% for session in chat_sessions %}
                    <div class="list-group-item px-0">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">{{ session.title[:30] }}{% if session.title|length > 30 %}...{% endif %}</h6>
                            <small>{{ session.created_at.strftime('%m/%d') if session.created_at else 'N/A' }}</small>
                        </div>
                        <small class="text-muted">
                            {% if session.has_refined %}
                            <span class="badge bg-info">Refined</span>
                            {% endif %}
                        </small>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center">No chat sessions found.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function deleteUser(userId, userName, userEmail) {
    if (confirm(`Are you sure you want to delete user "${userName}" (${userEmail})? This will permanently delete their account and all associated data. This action cannot be undone.`)) {
        fetch(`/admin/api/users/${userId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.href = '{{ url_for("admin.users") }}';
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete user');
        });
    }
}

function toggleUserActive(userId, userName, isActive) {
    const action = isActive ? 'deactivate' : 'activate';
    if (confirm(`Are you sure you want to ${action} user "${userName}"?`)) {
        fetch(`/admin/api/users/${userId}/toggle-active`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update user status');
        });
    }
}

function resetUserLimits(userId, userName) {
    if (confirm(`Are you sure you want to reset monthly limits for user "${userName}"?`)) {
        fetch(`/admin/api/users/${userId}/reset-limits`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to reset user limits');
        });
    }
}

function deleteContent(contentId, contentTitle) {
    if (confirm(`Are you sure you want to delete the content "${contentTitle}"? This action cannot be undone.`)) {
        fetch(`/admin/api/content/${contentId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete content');
        });
    }
}
</script>
{% endblock %}
