{% extends "studio_layout.html" %}

{% block title %}Article Studio - InkDrive{% endblock %}

{% block studio_title %}Create New Article{% endblock %}

{% block studio_description %}Generate a long-form, SEO-optimized article on any topic.{% endblock %}

{% block input_column %}
<div class="input-section">
    <div class="input-container">
        <textarea
            id="topicInput"
            class="topic-input"
            placeholder="What would you like to write about? Be specific for better results..."
            rows="3"
        ></textarea>
    </div>
    <div class="input-actions">
        <div class="refinements-info">
            {% if user %}
            <span>âœ¨ Authenticated users get 5 refinements per article</span>
            {% else %}
            <span>ðŸ”’ <a href="/auth/register">Sign up</a> for 5 refinements per article</span>
            {% endif %}
        </div>
        <button id="generateBtn" class="btn btn-primary generate-btn">
            <span class="material-symbols-outlined">auto_awesome</span>
            Generate Article
        </button>
    </div>
</div>

<!-- Refinement Section (hidden by default) -->
<div class="refinement-section" id="refinementSection" style="display: none;">
    <textarea
        id="refinementInput"
        class="refinement-input"
        placeholder="How would you like to refine this article? Be specific about changes you want..."
    ></textarea>
    <div class="refinement-actions">
        <span class="refinements-info" id="refinementsLeft">5 refinements remaining</span>
        <button id="refineBtn" class="btn btn-primary">
            <span class="material-symbols-outlined">tune</span>
            Refine Article
        </button>
    </div>
</div>

<!-- Article Actions (hidden by default) -->
<div class="article-actions" id="articleActions" style="display: none;">
    <button id="downloadBtn" class="btn btn-secondary">
        <span class="material-symbols-outlined">download</span>
        Download DOCX
    </button>
    {% if user %}
    <button id="publishBtn" class="btn btn-primary" style="display: none;">
        <span class="material-symbols-outlined">public</span>
        Publish Article
    </button>
    {% endif %}
</div>
{% endblock %}

{% block output_column %}
<div class="article-display" id="articleDisplay">
    <div class="empty-state">
        <span class="material-symbols-outlined">article</span>
        <h3>Ready to Create</h3>
        <p>Enter a topic above and click "Generate Article" to get started with AI-powered writing.</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Global variables
    let currentArticleData = null;
    let currentChatSessionId = null;
    let refinementsUsed = 0;
    let maxRefinements = {{ '5' if user else '1' }};
    let isAuthenticated = {{ 'true' if user else 'false' }};
    let articleGenerated = false; // Track if article has been generated

    // DOM elements
    const topicInput = document.getElementById('topicInput');
    const generateBtn = document.getElementById('generateBtn');
    const articleDisplay = document.getElementById('articleDisplay');
    const refinementSection = document.getElementById('refinementSection');
    const refinementInput = document.getElementById('refinementInput');
    const refineBtn = document.getElementById('refineBtn');
    const refinementsLeft = document.getElementById('refinementsLeft');
    const articleActions = document.getElementById('articleActions');
    const downloadBtn = document.getElementById('downloadBtn');
    const publishBtn = document.getElementById('publishBtn');

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Event listeners
        generateBtn.addEventListener('click', function(e) {
            if (articleGenerated) {
                e.preventDefault();
                return false;
            }
            generateArticle();
        });
        refineBtn.addEventListener('click', refineArticle);
        downloadBtn.addEventListener('click', downloadArticle);
        if (publishBtn) {
            publishBtn.addEventListener('click', publishArticle);
        }

        // Enter key handling
        topicInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey && !articleGenerated) {
                e.preventDefault();
                generateArticle();
            }
        });

        refinementInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                refineArticle();
            }
        });
    });

    // Utility functions
    function showNotification(message, type = 'success') {
        const existing = document.querySelector('.notification');
        if (existing) {
            existing.remove();
        }

        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => notification.classList.add('show'), 100);
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    function showLoading(message = 'Generating article...') {
        articleDisplay.innerHTML = `
            <div class="loading">
                <div class="spinner"></div>
                <span>${message}</span>
            </div>
        `;
    }

    function updateRefinementsDisplay() {
        const remaining = maxRefinements - refinementsUsed;
        refinementsLeft.textContent = `${remaining} refinements remaining`;

        if (remaining <= 0) {
            refineBtn.disabled = true;
            refinementInput.disabled = true;
            refinementInput.placeholder = 'No refinements remaining';
        }
    }

    function disableGenerateSection() {
        articleGenerated = true;
        generateBtn.disabled = true;
        topicInput.disabled = true;
        generateBtn.innerHTML = `
            <span class="material-symbols-outlined">check</span>
            Article Generated
        `;
        generateBtn.style.pointerEvents = 'none';
    }

    // Main functions
    async function generateArticle() {
        const topic = topicInput.value.trim();
        if (!topic) {
            showNotification('Please enter a topic', 'error');
            return;
        }

        generateBtn.disabled = true;
        showLoading();

        try {
            const endpoint = isAuthenticated ? '/api/v1/generate/article' : '/generate-guest';
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    topic: topic,
                    chat_session_id: currentChatSessionId
                })
            });

            const data = await response.json();

            if (response.ok) {
                currentArticleData = data;
                currentChatSessionId = data.chat_session_id;
                refinementsUsed = 0;
                maxRefinements = data.refinements_remaining + refinementsUsed;

                displayArticle(data.article_html);
                showRefinementSection();
                showArticleActions();
                updateRefinementsDisplay();

                showNotification('Article generated successfully!');
                disableGenerateSection();
            } else {
                throw new Error(data.error || 'Failed to generate article');
            }
        } catch (error) {
            console.error('Error generating article:', error);
            showNotification(error.message, 'error');
            articleDisplay.innerHTML = '<div class="empty-state"><h3>Error</h3><p>' + error.message + '</p></div>';
            generateBtn.disabled = false;
        }
    }

    async function refineArticle() {
        // ... (rest of the script is the same as before)
    }

    async function downloadArticle() {
        // ...
    }

    async function publishArticle() {
        // ...
    }

    function displayArticle(html) {
        articleDisplay.innerHTML = `<div class="article-content">${html}</div>`;
    }

    function showRefinementSection() {
        refinementSection.style.display = 'block';
    }

    function showArticleActions() {
        articleActions.style.display = 'flex';
    }
</script>
{% endblock %}
