{% extends "studio_template.html" %}

{% block title %}Article Studio{% endblock %}

{% block head_extra %}
{% endblock %}

{% block studio_title %}Article Studio{% endblock %}
{% block studio_description %}Generate a long-form, SEO-optimized article from a simple topic. Use the refinement box to edit the result.{% endblock %}

{% block studio_inputs %}
<div class="form-group">
    <label for="topicInput">Topic</label>
    <textarea id="topicInput" class="form-control" placeholder="What would you like to write about? Be specific for better results..." rows="3"></textarea>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="form-group">
            <label for="wordCountSelect">Target Word Count</label>
            <select id="wordCountSelect" class="form-control">
                <option value="500">Short (~500 words)</option>
                <option value="1000" selected>Medium (~1000 words)</option>
                <option value="2000">Long (~2000+ words)</option>
            </select>
        </div>
    </div>
    <div class="col-md-6">
        <div class="form-group">
            <label for="toneSelect">Tone of Voice</label>
            <select id="toneSelect" class="form-control">
                <option selected>Professional</option>
                <option>Casual & Friendly</option>
                <option>Academic</option>
                <option>Humorous</option>
                <option>Persuasive</option>
            </select>
        </div>
    </div>
</div>

<div class="form-group">
    <label for="audienceInput">Target Audience</label>
    <input type="text" id="audienceInput" class="form-control" placeholder="e.g., Beginners, experts, marketing managers">
</div>

{% if user.is_superadmin %}
<div class="form-group">
    <label>Super Admin Settings</label>
    <div class="custom-control custom-switch" style="padding: 10px; background: var(--surface-variant); border-radius: 8px;">
        <input type="checkbox" class="custom-control-input" id="imageToggle">
        <label class="custom-control-label" for="imageToggle" style="margin-left: 10px;">Enable Article Images (Default: Off)</label>
    </div>
</div>
{% endif %}

<div class="form-group">
    <label for="keyPointsInput">Key Points to Include (Optional)</label>
    <textarea id="keyPointsInput" class="form-control" placeholder="Enter key topics or arguments you want the article to cover, one per line." rows="4"></textarea>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="form-group">
            <label for="keywordInput">Primary SEO Keyword (Optional)</label>
            <input type="text" id="keywordInput" class="form-control" placeholder="e.g., 'sustainable energy solutions'">
        </div>
    </div>
    <div class="col-md-6">
        <div class="form-group">
            <label for="ctaInput">Call to Action (Optional)</label>
            <input type="text" id="ctaInput" class="form-control" placeholder="e.g., 'Sign up for our newsletter for more tips.'">
        </div>
    </div>
</div>

<div style="display: flex; gap: 12px;">
    <button id="newArticleBtn" class="btn btn-secondary">
        <span class="material-symbols-outlined">add</span>
        New Article
    </button>
    <button id="generateBtn" class="btn btn-primary" style="flex-grow: 1;">
        <span class="material-symbols-outlined">auto_awesome</span>
        Generate Article
    </button>
</div>

<hr style="margin: 24px 0; border: none; border-top: 1px solid var(--outline);">

<div id="refinementSection" style="display: none;">
    <div class="form-group">
        <label for="refinementInput">Refinement Instructions</label>
        <textarea id="refinementInput" class="form-control" placeholder="How would you like to refine this article? e.g., 'Make the tone more professional' or 'Add a section about AI ethics'..." rows="4"></textarea>
    </div>
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <button id="refineBtn" class="btn btn-primary">
            <span class="material-symbols-outlined">tune</span>
            Refine
        </button>
        <span id="refinementsLeft" style="font-size: 12px; color: var(--on-surface-variant);">5 refinements remaining</span>
    </div>
</div>

<!-- This section will be shown after generation -->
<div id="articleActions" style="display: none; margin-top: 24px; border-top: 1px solid var(--outline); padding-top: 24px;">
    <button id="downloadBtn" class="btn btn-secondary">
        <span class="material-symbols-outlined">download</span>
        Download DOCX
    </button>
</div>
{% endblock %}

{% block studio_output %}
<div id="articleDisplay">
    <div class="empty-state">
        <span class="material-symbols-outlined">article</span>
        <h3>Ready to Create</h3>
        <p>Enter a topic above and click "Generate Article" to get started.</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const STUDIO_TYPE = 'article';
</script>
<script>
    // This script is now self-contained within the Article Studio page.
    let currentArticleData = null;
    let currentChatSessionId = null;
    let refinementsUsed = 0;
    let maxRefinements = {{ '5' if user else '1' }};
    let isAuthenticated = {{ 'true' if user else 'false' }};

    const topicInput = document.getElementById('topicInput');
    const wordCountSelect = document.getElementById('wordCountSelect');
    const audienceInput = document.getElementById('audienceInput');
    const toneSelect = document.getElementById('toneSelect');
    const keyPointsInput = document.getElementById('keyPointsInput');
    const keywordInput = document.getElementById('keywordInput');
    const ctaInput = document.getElementById('ctaInput');
    const generateBtn = document.getElementById('generateBtn');
    const imageToggle = document.getElementById('imageToggle');
    const newArticleBtn = document.getElementById('newArticleBtn');
    const articleDisplay = document.getElementById('articleDisplay');
    const refinementSection = document.getElementById('refinementSection');
    const refinementInput = document.getElementById('refinementInput');
    const refineBtn = document.getElementById('refineBtn');
    const refinementsLeft = document.getElementById('refinementsLeft');
    const articleActions = document.getElementById('articleActions');
    const downloadBtn = document.getElementById('downloadBtn');
    document.addEventListener('DOMContentLoaded', function() {
        generateBtn.addEventListener('click', generateArticle);
        refineBtn.addEventListener('click', refineArticle);
        downloadBtn.addEventListener('click', downloadArticle);
        newArticleBtn.addEventListener('click', startNewArticle);
    });

    function startNewArticle() {
        // Clear inputs
        topicInput.value = '';
        wordCountSelect.value = '1000';
        audienceInput.value = '';
        toneSelect.value = 'Professional';
        keyPointsInput.value = '';
        keywordInput.value = '';
        ctaInput.value = '';

        // Reset output area
        articleDisplay.innerHTML = `
            <div class="empty-state">
                <span class="material-symbols-outlined">article</span>
                <h3>Ready to Create</h3>
                <p>Enter a topic above and click "Generate Article" to get started.</p>
            </div>
        `;

        // Hide refinement and action sections
        refinementSection.style.display = 'none';
        articleActions.style.display = 'none';

        // Reset state
        currentArticleData = null;
        currentChatSessionId = null;
        refinementsUsed = 0;
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<span class="material-symbols-outlined">auto_awesome</span> Generate Article';

        showNotification('New article started', 'success');
    }

    function showNotification(message, type = 'success') {
        const existing = document.querySelector('.notification');
        if (existing) existing.remove();
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => notification.classList.add('show'), 100);
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    function showLoading(message = 'Generating article...') {
        articleDisplay.innerHTML = `<div class="loading"><div class="spinner"></div><span>${message}</span></div>`;
    }

    function updateRefinementsDisplay() {
        const remaining = maxRefinements - refinementsUsed;
        refinementsLeft.textContent = `${remaining} refinements remaining`;
        if (remaining <= 0) {
            refineBtn.disabled = true;
            refinementInput.disabled = true;
            refinementInput.placeholder = 'No refinements remaining';
        }
    }

    async function generateArticle() {
        const topic = topicInput.value.trim();
        if (!topic) {
            showNotification('Please enter a topic', 'error');
            return;
        }

        generateBtn.disabled = true;
        showLoading();

        const settings = {
            wordCount: wordCountSelect.value,
            audience: audienceInput.value.trim(),
            tone: toneSelect.value,
            keyPoints: keyPointsInput.value.trim(),
            seoKeyword: keywordInput.value.trim(),
            cta: ctaInput.value.trim(),
            enable_images: imageToggle ? imageToggle.checked : false
        };

        try {
            const endpoint = isAuthenticated ? '/api/v1/generate/article' : '/api/v1/generate/article-guest';
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    topic: topic,
                    settings: settings,
                    chat_session_id: currentChatSessionId
                })
            });
            const data = await response.json();

            if (response.ok) {
                currentArticleData = data;
                currentChatSessionId = data.chat_session_id;
                refinementsUsed = 0;
                maxRefinements = data.refinements_remaining + refinementsUsed;

                articleDisplay.innerHTML = `<div class="article-content">${data.article_html}</div>`;
                refinementSection.style.display = 'block';
                articleActions.style.display = 'flex';
                updateRefinementsDisplay();
                showNotification('Article generated successfully!');
                generateBtn.innerHTML = `<span class="material-symbols-outlined">check</span> Generated`;
                if (typeof loadChatHistory === 'function') loadChatHistory(STUDIO_TYPE);
            } else {
                throw new Error(data.error || 'Failed to generate article');
            }
        } catch (error) {
            showNotification(error.message, 'error');
            generateBtn.disabled = false;
        }
    }

    async function refineArticle() {
        const refinementPrompt = refinementInput.value.trim();
        if (!refinementPrompt || !currentArticleData) return;

        if (refinementsUsed >= maxRefinements) {
            showNotification('No refinements remaining', 'error');
            return;
        }

        refineBtn.disabled = true;
        showLoading('Refining article...');

        try {
            const response = await fetch('/api/v1/refine/article', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    raw_text: currentArticleData.raw_text,
                    refinement_prompt: refinementPrompt,
                    article_id: currentArticleData.article_id,
                    chat_session_id: currentChatSessionId,
                    refinements_used: refinementsUsed,
                    topic: topicInput.value
                })
            });
            const data = await response.json();

            if (response.ok) {
                currentArticleData.article_html = data.article_html;
                currentArticleData.raw_text = data.raw_text;
                refinementsUsed = data.refinements_used;

                articleDisplay.innerHTML = `<div class="article-content">${data.article_html}</div>`;
                updateRefinementsDisplay();
                refinementInput.value = '';
                showNotification('Article refined successfully!');
                if (typeof loadChatHistory === 'function') loadChatHistory(STUDIO_TYPE);
            } else {
                throw new Error(data.error || 'Failed to refine article');
            }
        } catch (error) {
            showNotification(error.message, 'error');
        } finally {
            refineBtn.disabled = false;
        }
    }

    async function downloadArticle() {
        if (!currentArticleData) return;
        try {
            const response = await fetch('/download-docx', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    html: currentArticleData.article_html,
                    topic: topicInput.value,
                    article_id: currentArticleData.article_id
                })
            });
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${topicInput.value.substring(0, 50)}.docx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
                showNotification('Article downloaded successfully!');
            } else {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to download article');
            }
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }

    async function loadSessionIntoView(sessionId) {
        try {
            showLoading('Loading session...');
            const response = await fetch(`/api/chat-session/${sessionId}`);
            if (!response.ok) throw new Error('Failed to fetch session data.');

            const session = await response.json();

            // Assuming the user's input is the first message, and AI response is the second.
            const userMessage = session.messages[0].content;
            const aiResponseHtml = session.messages[1].content;

            topicInput.value = userMessage;
            articleDisplay.innerHTML = `<div class="article-content">${aiResponseHtml}</div>`;

            // Update state
            currentChatSessionId = session.session_id;
            currentArticleData = {
                raw_text: session.raw_text,
                article_html: aiResponseHtml,
                article_id: session.article_id
            };
            refinementsUsed = 0; // Reset refinements for a loaded session for now
            updateRefinementsDisplay();

            refinementSection.style.display = 'block';
            articleActions.style.display = 'flex';
            showNotification('Session loaded successfully!');
            generateBtn.innerHTML = `<span class="material-symbols-outlined">check</span> Loaded`;
            generateBtn.disabled = true;


        } catch (error) {
            showNotification(error.message, 'error');
        }
    }

</script>
{% endblock %}
