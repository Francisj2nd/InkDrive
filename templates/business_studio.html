{% extends "studio_template.html" %}

{% block title %}Business Docs Studio{% endblock %}

{% block studio_head_css %}
<style>
    /* Custom Tab Styles from Brainstorming Studio */
    .tabs {
        display: flex;
        border-bottom: 1px solid var(--outline);
        margin-bottom: 20px;
    }
    .tab-button {
        padding: 10px 20px;
        cursor: pointer;
        border: none;
        background: none;
        font-family: inherit;
        font-size: 14px;
        font-weight: 500;
        color: var(--on-surface-variant);
        border-bottom: 2px solid transparent;
        margin-bottom: -1px;
    }
    .tab-button.active {
        color: var(--primary-blue);
        border-bottom-color: var(--primary-blue);
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    .output-card {
        background: var(--surface-variant);
        border: 1px solid var(--outline);
        border-radius: 8px;
        padding: 16px;
        margin-top: 16px;
    }
    .output-content {
        white-space: pre-wrap;
    }
    .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid var(--outline);
        border-top: 2px solid var(--primary-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block studio_title %}Business Docs Studio{% endblock %}
{% block studio_description %}Generate structured proposals, formal reports, and professional press releases.{% endblock %}

{% block studio_inputs %}
<div class="tabs">
    <button class="tab-button active" data-tab="proposal">Proposal Writer</button>
    <button class="tab-button" data-tab="report">Formal Report</button>
    <button class="tab-button" data-tab="press-release">Press Release</button>
</div>

<!-- Proposal Writer Tab -->
<div id="proposal" class="tab-content active">
    <div class="form-group"><label for="prop-company">Your Company</label><input type="text" id="prop-company" class="form-control" placeholder="e.g., Nexus Digital Solutions"></div>
    <div class="form-group"><label for="prop-client">Client Name</label><input type="text" id="prop-client" class="form-control" placeholder="e.g., Innovate Corp"></div>
    <div class="form-group"><label for="prop-problem">Client's Problem</label><textarea id="prop-problem" class="form-control" rows="2" placeholder="e.g., Inefficient customer data management..."></textarea></div>
    <div class="form-group"><label for="prop-solution">Proposed Solution</label><textarea id="prop-solution" class="form-control" rows="3" placeholder="e.g., Implement a custom CRM..."></textarea></div>
    <div class="form-group"><label for="prop-deliverables">Deliverables (one per line)</label><textarea id="prop-deliverables" class="form-control" rows="3" placeholder="e.g., Phase 1: Discovery&#10;Phase 2: Implementation"></textarea></div>
    <div class="form-group"><label for="prop-tone">Tone</label><input type="text" id="prop-tone" class="form-control" placeholder="e.g., Formal and confident"></div>
</div>

<!-- Formal Report Generator Tab -->
<div id="report" class="tab-content">
    <div class="form-group"><label for="rep-type">Report Type</label><select id="rep-type" class="form-control"><option value="status_update" selected>Status Update</option><option value="financial_summary">Financial Summary</option><option value="incident_report">Incident Report</option></select></div>
    <div class="form-group"><label for="rep-subject">Subject</label><input type="text" id="rep-subject" class="form-control" placeholder="e.g., Q3 Marketing Campaign Performance"></div>
    <div class="form-group"><label for="rep-period">Time Period</label><input type="text" id="rep-period" class="form-control" placeholder="e.g., July 1, 2024 - September 30, 2024"></div>
    <div class="form-group"><label for="rep-data">Key Data Points (one per line)</label><textarea id="rep-data" class="form-control" rows="4" placeholder="e.g., Website traffic increased by 15%&#10;Lead conversion rate at 5.2%"></textarea></div>
    <div class="form-group"><label for="rep-audience">Target Audience</label><input type="text" id="rep-audience" class="form-control" placeholder="e.g., Senior Management"></div>
</div>

<!-- Press Release Writer Tab -->
<div id="press-release" class="tab-content">
    <div class="form-group"><label for="pr-headline">Headline</label><input type="text" id="pr-headline" class="form-control" placeholder="e.g., Innovate Inc. Launches Groundbreaking New AI Platform"></div>
    <div class="form-group"><label for="pr-company-info">Company Info (City, State)</label><input type="text" id="pr-company-info" class="form-control" placeholder="e.g., San Francisco, CA"></div>
    <div class="form-group"><label for="pr-key-info">Key Information (The 5 Ws)</label><textarea id="pr-key-info" class="form-control" rows="3" placeholder="Who, What, When, Where, Why..."></textarea></div>
    <div class="form-group"><label for="pr-quote">Quote (including speaker and title)</label><textarea id="pr-quote" class="form-control" rows="2" placeholder="e.g., 'This changes everything,' says Jane Doe, CEO."></textarea></div>
    <div class="form-group"><label for="pr-boilerplate">Company Boilerplate</label><textarea id="pr-boilerplate" class="form-control" rows="2" placeholder="e.g., Innovate Inc. is a leading provider of..."></textarea></div>
</div>

<div style="display: flex; gap: 12px; margin-top: 20px;">
    <button id="newSessionBtn" class="btn btn-secondary">
        <span class="material-symbols-outlined">add</span>
        New Session
    </button>
    <button id="generateBtn" class="btn btn-primary mt-3" style="flex-grow: 1;">
        <span class="material-symbols-outlined">business_center</span>
        Generate Document
    </button>
</div>
{% endblock %}

{% block studio_output %}
<div id="business-output-display">
    <div class="empty-state">
        <span class="material-symbols-outlined" style="font-size: 48px;">business_center</span>
        <p>Your generated business document will appear here.</p>
    </div>
</div>
{% endblock %}

{% block studio_scripts %}
<script>
    const STUDIO_TYPE = 'business';
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generateBtn');
    const outputDisplay = document.getElementById('business-output-display');
    const tabs = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    let businessChatSessionId = null;

    // --- Tab Switching Logic ---
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(tab.dataset.tab).classList.add('active');
        });
    });

    // --- Main Generate Function ---
    document.getElementById('newSessionBtn')?.addEventListener('click', startNewSession);

    function setInputsDisabled(disabled) {
        // Proposal
        document.getElementById('prop-company').disabled = disabled;
        document.getElementById('prop-client').disabled = disabled;
        document.getElementById('prop-problem').disabled = disabled;
        document.getElementById('prop-solution').disabled = disabled;
        document.getElementById('prop-deliverables').disabled = disabled;
        document.getElementById('prop-tone').disabled = disabled;

        // Report
        document.getElementById('rep-type').disabled = disabled;
        document.getElementById('rep-subject').disabled = disabled;
        document.getElementById('rep-period').disabled = disabled;
        document.getElementById('rep-data').disabled = disabled;
        document.getElementById('rep-audience').disabled = disabled;

        // Press Release
        document.getElementById('pr-headline').disabled = disabled;
        document.getElementById('pr-company-info').disabled = disabled;
        document.getElementById('pr-key-info').disabled = disabled;
        document.getElementById('pr-quote').disabled = disabled;
        document.getElementById('pr-boilerplate').disabled = disabled;

        generateBtn.disabled = disabled;
    }

    function startNewSession() {
        setInputsDisabled(false);
        // Clear inputs
        document.getElementById('prop-company').value = '';
        document.getElementById('prop-client').value = '';
        document.getElementById('prop-problem').value = '';
        document.getElementById('prop-solution').value = '';
        document.getElementById('prop-deliverables').value = '';
        document.getElementById('prop-tone').value = '';

        document.getElementById('rep-subject').value = '';
        document.getElementById('rep-period').value = '';
        document.getElementById('rep-data').value = '';
        document.getElementById('rep-audience').value = '';

        document.getElementById('pr-headline').value = '';
        document.getElementById('pr-company-info').value = '';
        document.getElementById('pr-key-info').value = '';
        document.getElementById('pr-quote').value = '';
        document.getElementById('pr-boilerplate').value = '';

        outputDisplay.innerHTML = `<div class="empty-state"><span class="material-symbols-outlined" style="font-size: 48px;">business_center</span><p>Your generated business document will appear here.</p></div>`;
        businessChatSessionId = null;
        if (typeof showNotification === 'function') {
            showNotification('New session started.', 'success');
        }
    }

    if (generateBtn) {
        generateBtn.addEventListener('click', async () => {
            const tool = document.querySelector('.tab-button.active')?.dataset.tab;
            if (!tool) return alert('Error: Could not find active tool.');

            const settings = gatherInputs(tool);
            if (!settings) return alert('Please fill in all required fields for the selected tool.');

            showLoading();
            try {
                const response = await fetch('/api/v1/generate/business', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tool, settings, chat_session_id: businessChatSessionId })
                });
                const data = await response.json();
                if (response.ok) {
                    businessChatSessionId = data.chat_session_id;
                    displayOutput(data.result);
                    if (typeof loadChatHistory === 'function') loadChatHistory(STUDIO_TYPE);
                    setInputsDisabled(true);
                } else {
                    throw new Error(data.error || 'Failed to generate content');
                }
            } catch (error) {
                showError(error.message);
            } finally {
                resetButton();
            }
        });
    }

    function gatherInputs(tool) {
        let settings = {};
        let isValid = true;
        if (tool === 'proposal') {
            settings.company = document.getElementById('prop-company').value;
            settings.client = document.getElementById('prop-client').value;
            settings.problem = document.getElementById('prop-problem').value;
            settings.solution = document.getElementById('prop-solution').value;
            settings.deliverables = document.getElementById('prop-deliverables').value;
            settings.tone = document.getElementById('prop-tone').value;
            if (!settings.company || !settings.client || !settings.problem || !settings.solution) isValid = false;
        } else if (tool === 'report') {
            settings.reportType = document.getElementById('rep-type').value;
            settings.subject = document.getElementById('rep-subject').value;
            settings.period = document.getElementById('rep-period').value;
            settings.dataPoints = document.getElementById('rep-data').value;
            settings.audience = document.getElementById('rep-audience').value;
            if (!settings.subject || !settings.period || !settings.dataPoints) isValid = false;
        } else if (tool === 'press-release') {
            settings.headline = document.getElementById('pr-headline').value;
            settings.companyInfo = document.getElementById('pr-company-info').value;
            settings.keyInfo = document.getElementById('pr-key-info').value;
            settings.quote = document.getElementById('pr-quote').value;
            settings.boilerplate = document.getElementById('pr-boilerplate').value;
            if (!settings.headline || !settings.keyInfo) isValid = false;
        }
        return isValid ? settings : null;
    }

    // --- UI Helper Functions ---
    function showLoading() {
        generateBtn.disabled = true;
        generateBtn.innerHTML = `<span class="material-symbols-outlined">hourglass_top</span> Generating...`;
        outputDisplay.innerHTML = `<div class="loading" style="padding: 40px; display:flex; justify-content: center; align-items: center; gap: 8px;"><div class="spinner"></div><span>Drafting your document...</span></div>`;
    }

    function showError(message) {
        outputDisplay.innerHTML = `<div class="output-card" style="color: var(--error);"><p><strong>Error:</strong> ${message}</p></div>`;
    }

    function resetButton() {
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<span class="material-symbols-outlined">business_center</span> Generate Document';
    }

    function displayOutput(text) {
        if (!text) return showError('The model did not return any content. Please try again.');
        outputDisplay.innerHTML = `<div class="output-card"><pre class="output-content">${text.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</pre></div>`;
    }
});
</script>
{% endblock %}
