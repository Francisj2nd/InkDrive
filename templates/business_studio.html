{% extends "studio_template.html" %}

{% block title %}Business Docs Studio{% endblock %}

{% block studio_head_css %}
<style>
    .tabs {
        display: flex;
        border-bottom: 1px solid var(--outline);
        margin-bottom: 20px;
    }
    .tab-button {
        padding: 10px 20px;
        cursor: pointer;
        border: none;
        background: none;
        font-family: inherit;
        font-size: 14px;
        font-weight: 500;
        color: var(--on-surface-variant);
        border-bottom: 2px solid transparent;
    }
    .tab-button.active {
        color: var(--primary-blue);
        border-bottom-color: var(--primary-blue);
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    .output-card {
        background: var(--surface-variant);
        border: 1px solid var(--outline);
        border-radius: 8px;
        padding: 16px;
        margin-top: 16px;
    }
    .output-card h4 {
        margin-top: 0;
        margin-bottom: 12px;
        font-weight: 500;
    }
    .output-content {
        white-space: pre-wrap;
        font-family: inherit;
        font-size: 14px;
        color: var(--on-surface);
    }
    .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid var(--outline);
        border-top: 2px solid var(--primary-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block studio_title %}Business Docs Studio{% endblock %}
{% block studio_description %}Generate professional press releases, job descriptions, and reports.{% endblock %}

{% block studio_inputs %}
<div class="tabs">
    <button class="tab-button active" data-tab="press-release">Press Release</button>
    <button class="tab-button" data-tab="job-description">Job Description</button>
</div>

<div id="press-release" class="tab-content active">
    <div class="form-group">
        <label for="pr-announcement">Announcement / Key Information</label>
        <textarea id="pr-announcement" class="form-control" rows="4" placeholder="e.g., Launch of our new flagship product, the 'Quantum Leap', on October 25th."></textarea>
    </div>
    <div class="form-group">
        <label for="pr-company">Company Name</label>
        <input type="text" id="pr-company" class="form-control" placeholder="e.g., Quantum Innovations Inc.">
    </div>
    <button id="generatePrBtn" class="btn btn-primary" style="width: 100%;">
        <span class="material-symbols-outlined">feed</span>
        Generate Press Release
    </button>
</div>

<div id="job-description" class="tab-content">
    <div class="form-group">
        <label for="jd-role">Job Role / Title</label>
        <input type="text" id="jd-role" class="form-control" placeholder="e.g., Senior Frontend Developer">
    </div>
    <div class="form-group">
        <label for="jd-responsibilities">Key Responsibilities (one per line)</label>
        <textarea id="jd-responsibilities" class="form-control" rows="4" placeholder="e.g., Develop and maintain user-facing features&#10;Collaborate with UI/UX designers&#10;Optimize applications for speed and scalability"></textarea>
    </div>
    <button id="generateJdBtn" class="btn btn-primary" style="width: 100%;">
        <span class="material-symbols-outlined">person_add</span>
        Generate Job Description
    </button>
</div>
{% endblock %}

{% block studio_output %}
<div id="business-output-display">
    <div class="empty-state">
        <span class="material-symbols-outlined" style="font-size: 48px;">business_center</span>
        <p>Your generated business document will appear here.</p>
    </div>
</div>
{% endblock %}

{% block studio_scripts %}
<script>
    const STUDIO_TYPE = 'business';
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- COMMON ELEMENTS ---
    const outputDisplay = document.getElementById('business-output-display');
    let businessChatSessionId = null; // Shared session for this studio

    // --- TAB SWITCHING ---
    const tabs = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(tab.dataset.tab).classList.add('active');
            // Clear output when switching tabs
            outputDisplay.innerHTML = `
                <div class="empty-state">
                    <span class="material-symbols-outlined" style="font-size: 48px;">business_center</span>
                    <p>Your generated business document will appear here.</p>
                </div>`;
        });
    });

    // --- PRESS RELEASE LOGIC ---
    const generatePrBtn = document.getElementById('generatePrBtn');
    if (generatePrBtn) {
        generatePrBtn.addEventListener('click', async () => {
            const announcement = document.getElementById('pr-announcement').value;
            const company = document.getElementById('pr-company').value;

            if (!announcement.trim() || !company.trim()) {
                alert('Please provide the announcement details and company name.');
                return;
            }
            showLoadingState("Writing your press release...");

            try {
                const response = await fetch('/api/v1/generate/business', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tool: 'press_release',
                        announcement: announcement,
                        company: company,
                        chat_session_id: businessChatSessionId
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    businessChatSessionId = data.chat_session_id;
                    displayOutput(data.press_release, 'Press Release');
                    if (typeof loadChatHistory === 'function') loadChatHistory(STUDIO_TYPE);
                } else { throw new Error(data.error); }
            } catch (error) {
                showErrorState(error.message);
            }
        });
    }

    // --- JOB DESCRIPTION LOGIC ---
    const generateJdBtn = document.getElementById('generateJdBtn');
    if (generateJdBtn) {
        generateJdBtn.addEventListener('click', async () => {
            const role = document.getElementById('jd-role').value;
            const responsibilities = document.getElementById('jd-responsibilities').value;

            if (!role.trim() || !responsibilities.trim()) {
                alert('Please provide the job role and key responsibilities.');
                return;
            }
            showLoadingState("Writing your job description...");

            try {
                const response = await fetch('/api/v1/generate/business', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tool: 'job_description',
                        role: role,
                        responsibilities: responsibilities,
                        chat_session_id: businessChatSessionId
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    businessChatSessionId = data.chat_session_id;
                    displayOutput(data.job_description, 'Job Description');
                    if (typeof loadChatHistory === 'function') loadChatHistory(STUDIO_TYPE);
                } else { throw new Error(data.error); }
            } catch (error) {
                showErrorState(error.message);
            }
        });
    }

    // --- DISPLAY FUNCTIONS ---
    function showLoadingState(message) {
        const btn = document.querySelector('.tab-content.active button');
        btn.disabled = true;
        btn.innerHTML = `<span class="material-symbols-outlined">hourglass_top</span> Generating...`;
        outputDisplay.innerHTML = `<div class="loading" style="padding: 40px; display:flex; justify-content: center; align-items: center; gap: 8px;"><div class="spinner"></div><span>${message}</span></div>`;
    }

    function showErrorState(message) {
        resetButtonStates();
        outputDisplay.innerHTML = `<div class="output-card"><p style="color: red;">Error: ${message}</p></div>`;
    }

    function displayOutput(text, title) {
        resetButtonStates();
        if (!text) {
            showErrorState(`The model did not return a ${title.toLowerCase()}. Please try again.`);
            return;
        }
        outputDisplay.innerHTML = `
            <div class="output-card">
                <h4>${title}</h4>
                <pre class="output-content">${text.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</pre>
            </div>
        `;
    }

    function resetButtonStates() {
        if(generatePrBtn) {
            generatePrBtn.disabled = false;
            generatePrBtn.innerHTML = '<span class="material-symbols-outlined">feed</span> Generate Press Release';
        }
        if(generateJdBtn) {
            generateJdBtn.disabled = false;
            generateJdBtn.innerHTML = '<span class="material-symbols-outlined">person_add</span> Generate Job Description';
        }
    }

    window.loadSessionIntoView = async function(sessionId) {
        try {
            showLoadingState("Loading session...");
            const response = await fetch(`/api/chat-session/${sessionId}`);
            if (!response.ok) throw new Error('Failed to fetch session data.');

            const session = await response.json();
            businessChatSessionId = session.session_id;

            const userInput = JSON.parse(session.messages[0].content);

            if (session.studio_type === 'PRESS_RELEASE') {
                document.querySelector('.tab-button[data-tab="press-release"]').click();
                document.getElementById('pr-announcement').value = userInput.announcement || '';
                document.getElementById('pr-company').value = userInput.company || '';
                document.getElementById('generatePrBtn').disabled = true;
                displayOutput(session.raw_text, 'Press Release');
            } else if (session.studio_type === 'JOB_DESCRIPTION') {
                document.querySelector('.tab-button[data-tab="job-description"]').click();
                document.getElementById('jd-role').value = userInput.role || '';
                document.getElementById('jd-responsibilities').value = userInput.responsibilities || '';
                document.getElementById('generateJdBtn').disabled = true;
                displayOutput(session.raw_text, 'Job Description');
            }

            if (typeof showNotification === 'function') {
                showNotification('Session loaded successfully!');
            }

        } catch (error) {
            showErrorState(error.message);
        }
    }
});
</script>
{% endblock %}
