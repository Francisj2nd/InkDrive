{% extends "studio_template.html" %}

{% block title %}E-commerce Studio{% endblock %}

{% block studio_head_css %}
<style>
    #ecommerce-tabs.nav-tabs {
        display: flex;
        flex-wrap: wrap;
        padding-left: 0;
        margin-bottom: 0;
        list-style: none;
        border-bottom: 1px solid var(--outline);
    }
    #ecommerce-tabs .nav-link {
        display: block; /* Override the global flex display */
        border: 1px solid transparent;
        border-top-left-radius: .5rem;
        border-top-right-radius: .5rem;
        color: var(--on-surface-variant);
        background-color: transparent;
        margin-bottom: -1px;
        padding: .5rem 1rem;
        transition: background-color 0.2s, border-color 0.2s;
    }
    #ecommerce-tabs .nav-link:hover {
        border-color: var(--surface-container-high);
        background-color: var(--surface-container-high);
    }
    #ecommerce-tabs .nav-link.active {
        background-color: var(--surface-container-low);
        border-color: var(--outline) var(--outline) var(--surface-container-low);
        color: var(--on-surface);
        font-weight: 500;
    }
    .tab-content {
        background-color: var(--surface-container-low);
        padding: 20px;
        border: 1px solid var(--outline);
        border-top: none;
        border-radius: 0 0 8px 8px;
    }
    .output-card {
        background: var(--surface-variant);
        border: 1px solid var(--outline);
        border-radius: 8px;
        padding: 16px;
        margin-top: 16px;
    }
    .output-card h4 {
        margin-top: 0;
        margin-bottom: 12px;
        font-weight: 500;
    }
    .output-content {
        white-space: pre-wrap;
        font-family: inherit;
        font-size: 14px;
        color: var(--on-surface);
    }
    .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid var(--outline);
        border-top: 2px solid var(--primary-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .star-rating {
        display: flex;
        flex-direction: row-reverse;
        justify-content: flex-end;
        gap: 4px;
    }
    .star-rating input[type="radio"] {
        display: none;
    }
    .star-rating label {
        cursor: pointer;
        font-size: 24px;
        color: var(--outline);
        transition: color 0.2s;
    }
    .star-rating input[type="radio"]:checked ~ label,
    .star-rating label:hover,
    .star-rating label:hover ~ label {
        color: var(--primary-yellow);
    }
</style>
{% endblock %}

{% block studio_title %}E-commerce Studio{% endblock %}
{% block studio_description %}Generate product descriptions, campaign ideas, and customer review responses.{% endblock %}

{% block studio_inputs %}
<!-- Tab Navigation -->
<ul class="nav nav-tabs" id="ecommerce-tabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="description-tab-btn" data-bs-toggle="tab" data-bs-target="#description-tab" type="button" role="tab" aria-controls="description-tab" aria-selected="true" data-tool="description">Product Description</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="campaign-tab-btn" data-bs-toggle="tab" data-bs-target="#campaign-tab" type="button" role="tab" aria-controls="campaign-tab" aria-selected="false" data-tool="campaign">Promo Campaign</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="review-tab-btn" data-bs-toggle="tab" data-bs-target="#review-tab" type="button" role="tab" aria-controls="review-tab" aria-selected="false" data-tool="review">Review Responder</button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="ecommerce-tabs-content">
    <!-- Product Description Tab -->
    <div class="tab-pane fade show active" id="description-tab" role="tabpanel" aria-labelledby="description-tab-btn">
        <div class="form-group">
            <label for="desc-product-name">Product Name</label>
            <input type="text" id="desc-product-name" class="form-control" placeholder="e.g., Artisan Leather Journal">
        </div>
        <div class="form-group">
            <label for="desc-features">Key Features (one per line)</label>
            <textarea id="desc-features" class="form-control" rows="3" placeholder="e.g., Hand-stitched binding&#10;120gsm recycled paper"></textarea>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="desc-audience">Target Audience</label>
                    <input type="text" id="desc-audience" class="form-control" placeholder="e.g., Writers, students">
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="desc-tone">Tone of Voice</label>
                    <input type="text" id="desc-tone" class="form-control" placeholder="e.g., Luxurious, playful">
                </div>
            </div>
        </div>
        <div class="row">
             <div class="col-md-6">
                <div class="form-group">
                    <label for="desc-benefit">Primary Benefit</label>
                    <input type="text" id="desc-benefit" class="form-control" placeholder="e.g., Capture your best ideas">
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="desc-format">Output Format</label>
                    <select id="desc-format" class="form-control">
                        <option value="paragraph" selected>Paragraph</option>
                        <option value="bullet_points">Bullet Points</option>
                        <option value="paragraph_with_bullets">Paragraph with Bullets</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Promotional Campaign Tab -->
    <div class="tab-pane fade" id="campaign-tab" role="tabpanel" aria-labelledby="campaign-tab-btn">
        <div class="form-group">
            <label for="camp-product">Product/Service</label>
            <input type="text" id="camp-product" class="form-control" placeholder="e.g., Premium Coffee Subscription Box">
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="camp-occasion">Campaign Occasion</label>
                    <input type="text" id="camp-occasion" class="form-control" placeholder="e.g., Black Friday, New Year Sale">
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="camp-offer">The Offer</label>
                    <input type="text" id="camp-offer" class="form-control" placeholder="e.g., 25% off all plans">
                </div>
            </div>
        </div>
        <div class="form-group">
            <label for="camp-urgency">Urgency Element</label>
            <input type="text" id="camp-urgency" class="form-control" placeholder="e.g., 48-hour flash sale, Ends Sunday night">
        </div>
        <div class="form-group">
            <label>Assets to Generate</label>
            <div class="checkbox-grid">
                <div class="checkbox-item"><input type="checkbox" id="asset-email" value="email" checked><label for="asset-email">Email Copy</label></div>
                <div class="checkbox-item"><input type="checkbox" id="asset-sms" value="sms"><label for="asset-sms">SMS Blast</label></div>
                <div class="checkbox-item"><input type="checkbox" id="asset-social" value="social" checked><label for="asset-social">Social Media Post</label></div>
                <div class="checkbox-item"><input type="checkbox" id="asset-banner" value="banner"><label for="asset-banner">Banner Ad Copy</label></div>
            </div>
        </div>
    </div>

    <!-- Customer Review Responder Tab -->
    <div class="tab-pane fade" id="review-tab" role="tabpanel" aria-labelledby="review-tab-btn">
        <div class="form-group">
            <label for="rev-review">Customer's Review</label>
            <textarea id="rev-review" class="form-control" rows="4" placeholder="Paste the customer's review here..."></textarea>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label>Star Rating</label>
                    <div class="star-rating">
                        <input type="radio" id="star5" name="rating" value="5" /><label for="star5" title="5 stars">&#9733;</label>
                        <input type="radio" id="star4" name="rating" value="4" /><label for="star4" title="4 stars">&#9733;</label>
                        <input type="radio" id="star3" name="rating" value="3" checked /><label for="star3" title="3 stars">&#9733;</label>
                        <input type="radio" id="star2" name="rating" value="2" /><label for="star2" title="2 stars">&#9733;</label>
                        <input type="radio" id="star1" name="rating" value="1" /><label for="star1" title="1 star">&#9733;</label>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="rev-tone">Response Tone</label>
                    <select id="rev-tone" class="form-control">
                        <option value="Empathetic & Helpful" selected>Empathetic & Helpful</option>
                        <option value="Professional & Direct">Professional & Direct</option>
                        <option value="Friendly & Appreciative">Friendly & Appreciative</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="form-group">
            <label for="rev-offer">Action / Offer (Optional)</label>
            <input type="text" id="rev-offer" class="form-control" placeholder="e.g., Offer a 15% discount on their next purchase">
        </div>
    </div>
</div>

<button id="generateBtn" class="btn btn-primary mt-3" style="width: 100%;">
    <span class="material-symbols-outlined">storefront</span>
    Generate
</button>
{% endblock %}

{% block studio_output %}
<div id="ecommerce-output-display">
    <div class="empty-state">
        <span class="material-symbols-outlined" style="font-size: 48px;">storefront</span>
        <p>Your generated e-commerce copy will appear here.</p>
    </div>
</div>
{% endblock %}

{% block studio_scripts %}
<script>
    const STUDIO_TYPE = 'ecommerce';
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generateBtn');
    const outputDisplay = document.getElementById('ecommerce-output-display');
    const tabs = document.querySelectorAll('#ecommerce-tabs .nav-link');
    let ecommerceChatSessionId = null;

    function getActiveTool() {
        const activeTab = document.querySelector('#ecommerce-tabs .nav-link.active');
        return activeTab ? activeTab.getAttribute('data-tool') : null;
    }

    function gatherInputs(tool) {
        let settings = { tool: tool };
        let isValid = true;

        if (tool === 'description') {
            settings.productName = document.getElementById('desc-product-name').value;
            settings.features = document.getElementById('desc-features').value;
            settings.audience = document.getElementById('desc-audience').value;
            settings.tone = document.getElementById('desc-tone').value;
            settings.benefit = document.getElementById('desc-benefit').value;
            settings.format = document.getElementById('desc-format').value;
            if (!settings.productName || !settings.features) isValid = false;
        } else if (tool === 'campaign') {
            settings.product = document.getElementById('camp-product').value;
            settings.occasion = document.getElementById('camp-occasion').value;
            settings.offer = document.getElementById('camp-offer').value;
            settings.urgency = document.getElementById('camp-urgency').value;
            settings.assets = Array.from(document.querySelectorAll('#campaign-tab .checkbox-grid input:checked')).map(el => el.value);
            if (!settings.product || !settings.occasion || !settings.offer) isValid = false;
        } else if (tool === 'review') {
            settings.review = document.getElementById('rev-review').value;
            const ratingElement = document.querySelector('#review-tab .star-rating input:checked');
            settings.rating = ratingElement ? ratingElement.value : '3';
            settings.tone = document.getElementById('rev-tone').value;
            settings.offer = document.getElementById('rev-offer').value;
            if (!settings.review) isValid = false;
        }

        return isValid ? settings : null;
    }

    if (generateBtn) {
        generateBtn.addEventListener('click', async () => {
            const tool = getActiveTool();
            if (!tool) {
                alert('Could not determine the active tool.');
                return;
            }

            const settings = gatherInputs(tool);
            if (!settings) {
                alert('Please fill in all required fields for the selected tool.');
                return;
            }

            generateBtn.disabled = true;
            generateBtn.innerHTML = `<span class="material-symbols-outlined">hourglass_top</span> Generating...`;
            outputDisplay.innerHTML = `<div class="loading" style="padding: 40px; display:flex; justify-content: center; align-items: center; gap: 8px;"><div class="spinner"></div><span>Generating content...</span></div>`;

            try {
                const response = await fetch('/api/v1/generate/ecommerce', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tool: tool,
                        settings: settings,
                        chat_session_id: ecommerceChatSessionId
                    })
                });
                const data = await response.json();

                if (response.ok) {
                    ecommerceChatSessionId = data.chat_session_id;
                    displayOutput(data.result);
                    if (typeof loadChatHistory === 'function') {
                        loadChatHistory(STUDIO_TYPE);
                    }
                } else {
                    throw new Error(data.error || 'Failed to generate content');
                }
            } catch (error) {
                outputDisplay.innerHTML = `<div class="output-card"><p style="color: red;">Error: ${error.message}</p></div>`;
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<span class="material-symbols-outlined">storefront</span> Generate';
            }
        });
    }

    function displayOutput(text) {
        if (!text) {
            outputDisplay.innerHTML = '<div class="output-card"><p>The model did not return any content. Please try again.</p></div>';
            return;
        }
        outputDisplay.innerHTML = `
            <div class="output-card">
                <h4>Generated Copy</h4>
                <pre class="output-content">${text.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</pre>
            </div>
        `;
    }

    // Simplified session loading for now. A more robust solution would be needed for production.
    window.loadSessionIntoView = async function(sessionId) {
        try {
            outputDisplay.innerHTML = `<div class="loading" style="padding: 40px; display:flex; justify-content: center; align-items: center; gap: 8px;"><div class="spinner"></div><span>Loading session...</span></div>`;
            const response = await fetch(`/api/chat-session/${sessionId}`);
            if (!response.ok) throw new Error('Failed to fetch session data.');

            const session = await response.json();
            ecommerceChatSessionId = session.session_id;

            const userInput = JSON.parse(session.messages[0].content);
            const tool = userInput.tool;
            const settings = userInput.settings || {};

            // Activate the correct tab
            const tabButton = document.querySelector(`#ecommerce-tabs .nav-link[data-tool="${tool}"]`);
            if (tabButton) {
                new bootstrap.Tab(tabButton).show();
            }

            // Populate fields - this is a simplified example
            if (tool === 'description') {
                document.getElementById('desc-product-name').value = settings.productName || '';
                document.getElementById('desc-features').value = settings.features || '';
            } // ... add logic for other tabs if needed

            displayOutput(session.raw_text);

            if (typeof showNotification === 'function') {
                showNotification('Session loaded successfully!');
            }

        } catch (error) {
            outputDisplay.innerHTML = `<div class="output-card"><p style="color: red;">Error: ${error.message}</p></div>`;
        }
    }
});
</script>
{% endblock %}
