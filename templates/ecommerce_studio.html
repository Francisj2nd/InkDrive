{% extends "studio_template.html" %}

{% block title %}E-commerce Studio{% endblock %}

{% block studio_head_css %}
<style>
    .output-card {
        background: var(--surface-variant);
        border: 1px solid var(--outline);
        border-radius: 8px;
        padding: 16px;
        margin-top: 16px;
    }
    .output-card h4 {
        margin-top: 0;
        margin-bottom: 12px;
        font-weight: 500;
    }
    .output-content {
        white-space: pre-wrap;
        font-family: inherit;
        font-size: 14px;
        color: var(--on-surface);
    }
    .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid var(--outline);
        border-top: 2px solid var(--primary-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block studio_title %}E-commerce Studio{% endblock %}
{% block studio_description %}Write compelling product descriptions and marketing copy.{% endblock %}

{% block studio_inputs %}
<div class="form-group">
    <label for="product-name">Product Name</label>
    <input type="text" id="product-name" class="form-control" placeholder="e.g., Artisan Leather Journal">
</div>
<div class="form-group">
    <label for="product-features">Key Features (one per line)</label>
    <textarea id="product-features" class="form-control" rows="4" placeholder="e.g., Hand-stitched binding&#10;Recycled paper&#10;Comes in three colors"></textarea>
</div>
<div class="form-group">
    <label for="product-tone">Tone</label>
    <select id="product-tone" class="form-control">
        <option value="Persuasive & Exciting">Persuasive & Exciting</option>
        <option value="Luxurious & Elegant">Luxurious & Elegant</option>
        <option value="Playful & Fun">Playful & Fun</option>
        <option value="Simple & Direct">Simple & Direct</option>
    </select>
</div>
<button id="generateDescBtn" class="btn btn-primary" style="width: 100%;">
    <span class="material-symbols-outlined">storefront</span>
    Generate Description
</button>
{% endblock %}

{% block studio_output %}
<div id="ecommerce-output-display">
    <div class="empty-state">
        <span class="material-symbols-outlined" style="font-size: 48px;">storefront</span>
        <p>Your generated product description will appear here.</p>
    </div>
</div>
{% endblock %}

{% block studio_scripts %}
<script>
    const STUDIO_TYPE = 'ecommerce';
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generateDescBtn');
    const outputDisplay = document.getElementById('ecommerce-output-display');
    let ecommerceChatSessionId = null;

    if (generateBtn) {
        generateBtn.addEventListener('click', async () => {
            const name = document.getElementById('product-name').value;
            const features = document.getElementById('product-features').value;
            const tone = document.getElementById('product-tone').value;

            if (!name.trim() || !features.trim()) {
                alert('Please enter a product name and at least one feature.');
                return;
            }

            generateBtn.disabled = true;
            generateBtn.innerHTML = `<span class="material-symbols-outlined">hourglass_top</span> Generating...`;
            outputDisplay.innerHTML = `<div class="loading" style="padding: 40px; display:flex; justify-content: center; align-items: center; gap: 8px;"><div class="spinner"></div><span>Writing your description...</span></div>`;

            try {
                const response = await fetch('/api/v1/generate/ecommerce', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        features: features,
                        tone: tone,
                        chat_session_id: ecommerceChatSessionId
                    })
                });
                const data = await response.json();

                if (response.ok) {
                    ecommerceChatSessionId = data.chat_session_id;
                    displayDescription(data.description);
                    if (typeof loadChatHistory === 'function') {
                        loadChatHistory(STUDIO_TYPE);
                    }
                } else {
                    throw new Error(data.error || 'Failed to generate description');
                }
            } catch (error) {
                outputDisplay.innerHTML = `<div class="output-card"><p style="color: red;">Error: ${error.message}</p></div>`;
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<span class="material-symbols-outlined">storefront</span> Generate Description';
            }
        });
    }

    function displayDescription(descText) {
        if (!descText) {
            outputDisplay.innerHTML = '<div class="output-card"><p>The model did not return a description. Please try again.</p></div>';
            return;
        }

        outputDisplay.innerHTML = `
            <div class="output-card">
                <h4>Product Description</h4>
                <pre class="output-content">${descText.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</pre>
            </div>
        `;
    }

    async function loadSessionIntoView(sessionId) {
        try {
            outputDisplay.innerHTML = `<div class="loading" style="padding: 40px; display:flex; justify-content: center; align-items: center; gap: 8px;"><div class="spinner"></div><span>Loading session...</span></div>`;
            const response = await fetch(`/api/chat-session/${sessionId}`);
            if (!response.ok) throw new Error('Failed to fetch session data.');

            const session = await response.json();

            ecommerceChatSessionId = session.session_id;
            displayDescription(session.raw_text);

            if (typeof showNotification === 'undefined') {
                window.showNotification = (message, type = 'success') => {
                    const existing = document.querySelector('.notification');
                    if (existing) existing.remove();
                    const notification = document.createElement('div');
                    notification.className = `notification ${type}`;
                    notification.textContent = message;
                    document.body.appendChild(notification);
                    setTimeout(() => notification.classList.add('show'), 100);
                    setTimeout(() => {
                        notification.classList.remove('show');
                        setTimeout(() => notification.remove(), 300);
                    }, 3000);
                };
            }
            showNotification('Session loaded successfully!');

        } catch (error) {
            outputDisplay.innerHTML = `<div class="output-card"><p style="color: red;">Error: ${error.message}</p></div>`;
        }
    }
});
</script>
{% endblock %}
