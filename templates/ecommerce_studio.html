{% extends "studio_template.html" %}

{% block title %}E-commerce Studio{% endblock %}

{% block studio_head_css %}
<style>
    /* Custom Tab Styles from Brainstorming Studio */
    .tabs {
        display: flex;
        border-bottom: 1px solid var(--outline);
        margin-bottom: 20px;
    }
    .tab-button {
        padding: 10px 20px;
        cursor: pointer;
        border: none;
        background: none;
        font-family: inherit;
        font-size: 14px;
        font-weight: 500;
        color: var(--on-surface-variant);
        border-bottom: 2px solid transparent;
        margin-bottom: -1px;
    }
    .tab-button.active {
        color: var(--primary-blue);
        border-bottom-color: var(--primary-blue);
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }

    /* General Studio Styles */
    .output-card {
        background: var(--surface-variant);
        border: 1px solid var(--outline);
        border-radius: 8px;
        padding: 16px;
        margin-top: 16px;
    }
    .output-card h4 {
        margin-top: 0;
        margin-bottom: 12px;
        font-weight: 500;
    }
    .output-content {
        white-space: pre-wrap;
        font-family: inherit;
        font-size: 14px;
        color: var(--on-surface);
    }
    .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid var(--outline);
        border-top: 2px solid var(--primary-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .star-rating {
        display: flex;
        flex-direction: row-reverse;
        justify-content: flex-end;
        gap: 4px;
    }
    .star-rating input[type="radio"] {
        display: none;
    }
    .star-rating label {
        cursor: pointer;
        font-size: 24px;
        color: var(--outline);
        transition: color 0.2s;
    }
    .star-rating input[type="radio"]:checked ~ label,
    .star-rating label:hover,
    .star-rating label:hover ~ label {
        color: var(--primary-yellow);
    }
</style>
{% endblock %}

{% block studio_title %}E-commerce Studio{% endblock %}
{% block studio_description %}Generate product descriptions, campaign ideas, and customer review responses.{% endblock %}

{% block studio_inputs %}
<div class="tabs">
    <button class="tab-button active" data-tab="description">Product Description</button>
    <button class="tab-button" data-tab="campaign">Promo Campaign</button>
    <button class="tab-button" data-tab="review">Review Responder</button>
</div>

<!-- Product Description Tab -->
<div id="description" class="tab-content active">
    <div class="form-group">
        <label for="desc-product-name">Product Name</label>
        <input type="text" id="desc-product-name" class="form-control" placeholder="e.g., Artisan Leather Journal">
    </div>
    <div class="form-group">
        <label for="desc-features">Key Features (one per line)</label>
        <textarea id="desc-features" class="form-control" rows="3" placeholder="e.g., Hand-stitched binding&#10;120gsm recycled paper"></textarea>
    </div>
    <div class="row">
        <div class="col-md-6"><div class="form-group"><label for="desc-audience">Target Audience</label><input type="text" id="desc-audience" class="form-control" placeholder="e.g., Writers, students"></div></div>
        <div class="col-md-6"><div class="form-group"><label for="desc-tone">Tone of Voice</label><input type="text" id="desc-tone" class="form-control" placeholder="e.g., Luxurious, playful"></div></div>
    </div>
    <div class="row">
         <div class="col-md-6"><div class="form-group"><label for="desc-benefit">Primary Benefit</label><input type="text" id="desc-benefit" class="form-control" placeholder="e.g., Capture your best ideas"></div></div>
        <div class="col-md-6"><div class="form-group"><label for="desc-format">Output Format</label><select id="desc-format" class="form-control"><option value="paragraph" selected>Paragraph</option><option value="bullet_points">Bullet Points</option><option value="paragraph_with_bullets">Paragraph with Bullets</option></select></div></div>
    </div>
</div>

<!-- Promotional Campaign Tab -->
<div id="campaign" class="tab-content">
    <div class="form-group"><label for="camp-product">Product/Service</label><input type="text" id="camp-product" class="form-control" placeholder="e.g., Premium Coffee Subscription Box"></div>
    <div class="row">
        <div class="col-md-6"><div class="form-group"><label for="camp-occasion">Campaign Occasion</label><input type="text" id="camp-occasion" class="form-control" placeholder="e.g., Black Friday, New Year Sale"></div></div>
        <div class="col-md-6"><div class="form-group"><label for="camp-offer">The Offer</label><input type="text" id="camp-offer" class="form-control" placeholder="e.g., 25% off all plans"></div></div>
    </div>
    <div class="form-group"><label for="camp-urgency">Urgency Element</label><input type="text" id="camp-urgency" class="form-control" placeholder="e.g., 48-hour flash sale"></div>
    <div class="form-group">
        <label>Assets to Generate</label>
        <div class="checkbox-grid">
            <div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" id="asset-email" value="email" checked><label class="form-check-label" for="asset-email">Email Copy</label></div>
            <div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" id="asset-sms" value="sms"><label class="form-check-label" for="asset-sms">SMS Blast</label></div>
            <div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" id="asset-social" value="social" checked><label class="form-check-label" for="asset-social">Social Media Post</label></div>
            <div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" id="asset-banner" value="banner"><label class="form-check-label" for="asset-banner">Banner Ad Copy</label></div>
        </div>
    </div>
</div>

<!-- Customer Review Responder Tab -->
<div id="review" class="tab-content">
    <div class="form-group"><label for="rev-review">Customer's Review</label><textarea id="rev-review" class="form-control" rows="4" placeholder="Paste the customer's review here..."></textarea></div>
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label>Star Rating</label>
                <div class="star-rating">
                    <input type="radio" id="star5" name="rating" value="5" /><label for="star5" title="5 stars">&#9733;</label>
                    <input type="radio" id="star4" name="rating" value="4" /><label for="star4" title="4 stars">&#9733;</label>
                    <input type="radio" id="star3" name="rating" value="3" checked /><label for="star3" title="3 stars">&#9733;</label>
                    <input type="radio" id="star2" name="rating" value="2" /><label for="star2" title="2 stars">&#9733;</label>
                    <input type="radio" id="star1" name="rating" value="1" /><label for="star1" title="1 star">&#9733;</label>
                </div>
            </div>
        </div>
        <div class="col-md-6"><div class="form-group"><label for="rev-tone">Response Tone</label><select id="rev-tone" class="form-control"><option value="Empathetic & Helpful" selected>Empathetic & Helpful</option><option value="Professional & Direct">Professional & Direct</option><option value="Friendly & Appreciative">Friendly & Appreciative</option></select></div></div>
    </div>
    <div class="form-group"><label for="rev-offer">Action / Offer (Optional)</label><input type="text" id="rev-offer" class="form-control" placeholder="e.g., Offer a 15% discount"></div>
</div>

<div style="display: flex; gap: 12px; margin-top: 20px;">
    <button id="newSessionBtn" class="btn btn-secondary">
        <span class="material-symbols-outlined">add</span>
        New Session
    </button>
    <button id="generateBtn" class="btn btn-primary mt-3" style="flex-grow: 1;">
        <span class="material-symbols-outlined">storefront</span>
        Generate
    </button>
</div>
{% endblock %}

{% block studio_output %}
<div id="ecommerce-output-display">
    <div class="empty-state">
        <span class="material-symbols-outlined" style="font-size: 48px;">storefront</span>
        <p>Your generated e-commerce copy will appear here.</p>
    </div>
</div>
{% endblock %}

{% block studio_scripts %}
<script>
    const STUDIO_TYPE = 'ecommerce';
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generateBtn');
    const outputDisplay = document.getElementById('ecommerce-output-display');
    const tabs = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    let ecommerceChatSessionId = null;

    // Custom Tab switching logic
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(tab.dataset.tab).classList.add('active');
        });
    });

    function getActiveTool() {
        const activeTab = document.querySelector('.tab-button.active');
        return activeTab ? activeTab.getAttribute('data-tab') : null;
    }

    function gatherInputs(tool) {
        let settings = {};
        let isValid = true;

        if (tool === 'description') {
            settings.productName = document.getElementById('desc-product-name').value;
            settings.features = document.getElementById('desc-features').value;
            settings.audience = document.getElementById('desc-audience').value;
            settings.tone = document.getElementById('desc-tone').value;
            settings.benefit = document.getElementById('desc-benefit').value;
            settings.format = document.getElementById('desc-format').value;
            if (!settings.productName || !settings.features) isValid = false;
        } else if (tool === 'campaign') {
            settings.product = document.getElementById('camp-product').value;
            settings.occasion = document.getElementById('camp-occasion').value;
            settings.offer = document.getElementById('camp-offer').value;
            settings.urgency = document.getElementById('camp-urgency').value;
            settings.assets = Array.from(document.querySelectorAll('#campaign .checkbox-grid input:checked')).map(el => el.value);
            if (!settings.product || !settings.occasion || !settings.offer) isValid = false;
        } else if (tool === 'review') {
            settings.review = document.getElementById('rev-review').value;
            const ratingElement = document.querySelector('#review .star-rating input:checked');
            settings.rating = ratingElement ? ratingElement.value : '3';
            settings.tone = document.getElementById('rev-tone').value;
            settings.offer = document.getElementById('rev-offer').value;
            if (!settings.review) isValid = false;
        }

        return isValid ? settings : null;
    }

    document.getElementById('newSessionBtn')?.addEventListener('click', startNewSession);

    function setInputsDisabled(disabled) {
        // Description
        document.getElementById('desc-product-name').disabled = disabled;
        document.getElementById('desc-features').disabled = disabled;
        document.getElementById('desc-audience').disabled = disabled;
        document.getElementById('desc-tone').disabled = disabled;
        document.getElementById('desc-benefit').disabled = disabled;
        document.getElementById('desc-format').disabled = disabled;

        // Campaign
        document.getElementById('camp-product').disabled = disabled;
        document.getElementById('camp-occasion').disabled = disabled;
        document.getElementById('camp-offer').disabled = disabled;
        document.getElementById('camp-urgency').disabled = disabled;
        document.querySelectorAll('#campaign .checkbox-grid input').forEach(el => el.disabled = disabled);

        // Review
        document.getElementById('rev-review').disabled = disabled;
        document.querySelectorAll('#review .star-rating input').forEach(el => el.disabled = disabled);
        document.getElementById('rev-tone').disabled = disabled;
        document.getElementById('rev-offer').disabled = disabled;

        generateBtn.disabled = disabled;
    }

    function startNewSession() {
        setInputsDisabled(false);
        // Clear inputs and reset to defaults
        document.getElementById('desc-product-name').value = '';
        document.getElementById('desc-features').value = '';
        document.getElementById('desc-audience').value = '';
        document.getElementById('desc-tone').value = '';
        document.getElementById('desc-benefit').value = '';
        document.getElementById('desc-format').value = 'paragraph';

        document.getElementById('camp-product').value = '';
        document.getElementById('camp-occasion').value = '';
        document.getElementById('camp-offer').value = '';
        document.getElementById('camp-urgency').value = '';

        document.getElementById('rev-review').value = '';
        document.getElementById('rev-offer').value = '';

        outputDisplay.innerHTML = `<div class="empty-state"><span class="material-symbols-outlined" style="font-size: 48px;">storefront</span><p>Your generated e-commerce copy will appear here.</p></div>`;
        ecommerceChatSessionId = null;
        if (typeof showNotification === 'function') {
            showNotification('New session started.', 'success');
        }
    }

    if (generateBtn) {
        generateBtn.addEventListener('click', async () => {
            const tool = getActiveTool();
            if (!tool) {
                alert('Could not determine the active tool.');
                return;
            }

            const settings = gatherInputs(tool);
            if (!settings) {
                alert('Please fill in all required fields for the selected tool.');
                return;
            }

            generateBtn.disabled = true;
            generateBtn.innerHTML = `<span class="material-symbols-outlined">hourglass_top</span> Generating...`;
            outputDisplay.innerHTML = `<div class="loading" style="padding: 40px; display:flex; justify-content: center; align-items: center; gap: 8px;"><div class="spinner"></div><span>Generating content...</span></div>`;

            try {
                const response = await fetch('/api/v1/generate/ecommerce', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tool: tool,
                        settings: settings,
                        chat_session_id: ecommerceChatSessionId
                    })
                });
                const data = await response.json();

                if (response.ok) {
                    ecommerceChatSessionId = data.chat_session_id;
                    displayOutput(data.result);
                    if (typeof loadChatHistory === 'function') {
                        loadChatHistory(STUDIO_TYPE);
                    }
                    setInputsDisabled(true);
                } else {
                    throw new Error(data.error || 'Failed to generate content');
                }
            } catch (error) {
                outputDisplay.innerHTML = `<div class="output-card"><p style="color: red;">Error: ${error.message}</p></div>`;
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<span class="material-symbols-outlined">storefront</span> Generate';
            }
        });
    }

    function displayOutput(text) {
        if (!text) {
            outputDisplay.innerHTML = '<div class="output-card"><p>The model did not return any content. Please try again.</p></div>';
            return;
        }
        outputDisplay.innerHTML = `
            <div class="output-card">
                <h4>Generated Copy</h4>
                <pre class="output-content">${text.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</pre>
            </div>
        `;
    }

    window.loadSessionIntoView = async function(sessionId) {
        try {
            outputDisplay.innerHTML = `<div class="loading" style="padding: 40px; display:flex; justify-content: center; align-items: center; gap: 8px;"><div class="spinner"></div><span>Loading session...</span></div>`;
            const response = await fetch(`/api/chat-session/${sessionId}`);
            if (!response.ok) throw new Error('Failed to fetch session data.');

            const session = await response.json();
            ecommerceChatSessionId = session.session_id;

            const userInput = JSON.parse(session.messages[0].content);
            const tool = userInput.tool;
            const settings = userInput.settings || {};

            // Activate the correct tab
            document.querySelector(`.tab-button[data-tab="${tool}"]`)?.click();

            // Restore inputs
            if (tool === 'description') {
                document.getElementById('desc-product-name').value = settings.productName || '';
                document.getElementById('desc-features').value = settings.features || '';
                document.getElementById('desc-audience').value = settings.audience || '';
                document.getElementById('desc-tone').value = settings.tone || '';
                document.getElementById('desc-benefit').value = settings.benefit || '';
                document.getElementById('desc-format').value = settings.format || 'paragraph';
            } else if (tool === 'campaign') {
                document.getElementById('camp-product').value = settings.product || '';
                document.getElementById('camp-occasion').value = settings.occasion || '';
                document.getElementById('camp-offer').value = settings.offer || '';
                document.getElementById('camp-urgency').value = settings.urgency || '';
            } else if (tool === 'review') {
                document.getElementById('rev-review').value = settings.review || '';
                document.getElementById('rev-tone').value = settings.tone || 'Empathetic & Helpful';
                document.getElementById('rev-offer').value = settings.offer || '';
            }

            displayOutput(session.raw_text);

            if (typeof showNotification === 'function') {
                showNotification('Session loaded successfully!');
            }
            setInputsDisabled(true);
        } catch (error) {
            showError(error.message);
        }
    }
});
</script>
{% endblock %}
