{% extends "studio_template.html" %}

{% block title %}Editing & Refinement Studio{% endblock %}

{% block studio_head_css %}
<style>
    .tabs {
        display: flex;
        border-bottom: 1px solid var(--outline);
        margin-bottom: 20px;
    }
    .tab-button {
        padding: 10px 20px;
        cursor: pointer;
        border: none;
        background: none;
        font-family: inherit;
        font-size: 14px;
        font-weight: 500;
        color: var(--on-surface-variant);
        border-bottom: 2px solid transparent;
    }
    .tab-button.active {
        color: var(--primary-blue);
        border-bottom-color: var(--primary-blue);
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    .output-card {
        background: var(--surface-variant);
        border: 1px solid var(--outline);
        border-radius: 8px;
        padding: 16px;
        margin-top: 16px;
    }
    .output-card h4 {
        margin-top: 0;
        margin-bottom: 12px;
        font-weight: 500;
    }
    .output-content {
        white-space: pre-wrap;
        font-family: inherit;
        font-size: 14px;
        color: var(--on-surface);
    }
    .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid var(--outline);
        border-top: 2px solid var(--primary-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block studio_title %}Editing & Refinement Studio{% endblock %}
{% block studio_description %}Paste your existing text and use our tools to refine and improve it.{% endblock %}

{% block studio_inputs %}
<div style="display: flex; gap: 12px; margin-bottom: 20px;">
    <button id="newSessionBtn" class="btn btn-secondary" style="width: 100%;">
        <span class="material-symbols-outlined">add</span>
        New Session
    </button>
</div>
<div class="tabs">
    <button class="tab-button active" data-tab="tone-style">Tone & Style</button>
    <button class="tab-button" data-tab="summarizer">Summarizer</button>
    <button class="tab-button" data-tab="translator">Translator & Localizer</button>
</div>

<div id="tone-style" class="tab-content active">
    <div class="form-group">
        <label for="refine-text-input">Your Text</label>
        <textarea id="refine-text-input" class="form-control" rows="8" placeholder="Paste your article, blog post, or any other text here..."></textarea>
    </div>
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label for="refine-goal">Refinement Goal</label>
                <select id="refine-goal" class="form-control">
                    <option>Improve Clarity</option>
                    <option>Make More Concise</option>
                    <option>Fix Grammar & Spelling</option>
                    <option>Change Tone</option>
                </select>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label for="refine-formality">Formality Level</label>
                <select id="refine-formality" class="form-control">
                    <option>Casual</option>
                    <option selected>Neutral</option>
                    <option>Formal</option>
                </select>
            </div>
        </div>
    </div>
    <div class="form-group">
        <label for="refine-audience">Target Audience (Optional)</label>
        <input type="text" id="refine-audience" class="form-control" placeholder="e.g., Industry experts, general consumers, beginners">
    </div>
    <button id="refineTextBtn" class="btn btn-primary" style="width: 100%;">
        <span class="material-symbols-outlined">auto_fix_high</span>
        Refine Text
    </button>
</div>

<div id="summarizer" class="tab-content">
    <div class="form-group">
        <label for="summarize-text-input">Text to Summarize</label>
        <textarea id="summarize-text-input" class="form-control" rows="8" placeholder="Paste a long piece of text here..."></textarea>
    </div>
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label for="summary-format">Summary Format</label>
                <select id="summary-format" class="form-control">
                    <option>Paragraph</option>
                    <option>Bullet Points</option>
                    <option>Executive Summary</option>
                </select>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label for="summary-extraction">Extraction Type</label>
                <select id="summary-extraction" class="form-control">
                    <option>Summarize</option>
                    <option>Extract Action Items</option>
                    <option>List Key Statistics</option>
                </select>
            </div>
        </div>
    </div>
    <div class="form-group">
        <label for="summary-focus">Focus Area (Optional)</label>
        <input type="text" id="summary-focus" class="form-control" placeholder="e.g., focus on financial results, technical challenges">
    </div>
    <button id="summarizeBtn" class="btn btn-primary" style="width: 100%;">
        <span class="material-symbols-outlined">compress</span>
        Summarize
    </button>
</div>

<div id="translator" class="tab-content">
    <div class="form-group">
        <label for="translate-text-input">Text to Translate</label>
        <textarea id="translate-text-input" class="form-control" rows="8" placeholder="Enter text in any language..."></textarea>
    </div>
    <div class="form-group">
        <label for="translate-locale">Target Locale</label>
        <select id="translate-locale" class="form-control">
            <option>English (USA)</option>
            <option>English (UK)</option>
            <option>Spanish (Spain)</option>
            <option>Spanish (Mexico)</option>
            <option>French (France)</option>
            <option>German (Germany)</option>
            <option>Japanese (Japan)</option>
        </select>
    </div>
    <div class="form-group">
        <label>Formality Level</label>
        <div>
            <div class="custom-control custom-radio custom-control-inline">
                <input type="radio" id="formality-informal" name="formality" class="custom-control-input" value="Informal">
                <label class="custom-control-label" for="formality-informal">Informal</label>
            </div>
            <div class="custom-control custom-radio custom-control-inline">
                <input type="radio" id="formality-formal" name="formality" class="custom-control-input" value="Formal" checked>
                <label class="custom-control-label" for="formality-formal">Formal</label>
            </div>
        </div>
    </div>
    <div class="form-group">
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="translate-idioms" checked>
            <label class="form-check-label" for="translate-idioms">Adapt Idioms & Cultural References</label>
        </div>
    </div>
    <button id="translateBtn" class="btn btn-primary" style="width: 100%;">
        <span class="material-symbols-outlined">translate</span>
        Translate
    </button>
</div>
{% endblock %}

{% block studio_output %}
<div id="editing-output-display">
    <div class="empty-state">
        <span class="material-symbols-outlined" style="font-size: 48px;">edit_note</span>
        <p>Your refined text will appear here.</p>
    </div>
</div>
{% endblock %}

{% block studio_scripts %}
<script>
    const STUDIO_TYPE = 'editing';
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- COMMON ELEMENTS ---
    const outputDisplay = document.getElementById('editing-output-display');
    let editingChatSessionId = null;

    // --- TAB SWITCHING ---
    const tabs = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(tab.dataset.tab).classList.add('active');
            outputDisplay.innerHTML = `<div class="empty-state"><span class="material-symbols-outlined" style="font-size: 48px;">edit_note</span><p>Your refined text will appear here.</p></div>`;
        });
    });

    // --- EVENT LISTENERS ---
    document.getElementById('newSessionBtn')?.addEventListener('click', startNewSession);
    document.getElementById('refineTextBtn')?.addEventListener('click', refineText);
    document.getElementById('summarizeBtn')?.addEventListener('click', summarizeText);
    document.getElementById('translateBtn')?.addEventListener('click', translateText);

    // --- HELPER FUNCTIONS ---
    function setInputsDisabled(disabled) {
        // Tone & Style
        document.getElementById('refine-text-input').disabled = disabled;
        document.getElementById('refine-goal').disabled = disabled;
        document.getElementById('refine-formality').disabled = disabled;
        document.getElementById('refine-audience').disabled = disabled;
        document.getElementById('refineTextBtn').disabled = disabled;

        // Summarizer
        document.getElementById('summarize-text-input').disabled = disabled;
        document.getElementById('summary-format').disabled = disabled;
        document.getElementById('summary-extraction').disabled = disabled;
        document.getElementById('summary-focus').disabled = disabled;
        document.getElementById('summarizeBtn').disabled = disabled;

        // Translator
        document.getElementById('translate-text-input').disabled = disabled;
        document.getElementById('translate-locale').disabled = disabled;
        document.querySelector('input[name="formality"]:checked').disabled = disabled;
        document.getElementById('translate-idioms').disabled = disabled;
        document.getElementById('translateBtn').disabled = disabled;
    }

    function startNewSession() {
        setInputsDisabled(false);

        // Clear all inputs
        document.getElementById('refine-text-input').value = '';
        document.getElementById('summarize-text-input').value = '';
        document.getElementById('translate-text-input').value = '';

        outputDisplay.innerHTML = `<div class="empty-state"><span class="material-symbols-outlined" style="font-size: 48px;">edit_note</span><p>Your refined text will appear here.</p></div>`;
        editingChatSessionId = null;
        showNotification('New session started.', 'success');
    }

    // --- API FUNCTIONS ---
    async function refineText() {
        const text = document.getElementById('refine-text-input').value;
        if (!text.trim()) { alert('Please paste some text to refine.'); return; }

        const settings = {
            goal: document.getElementById('refine-goal').value,
            formality: document.getElementById('refine-formality').value,
            audience: document.getElementById('refine-audience').value,
        };

        showLoading(this, "Applying tone & style...");
        try {
            const response = await fetch('/api/v1/refine/text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tool: 'tone_style', text: text, settings: settings, chat_session_id: editingChatSessionId })
            });
            const data = await response.json();
            if (response.ok) {
                editingChatSessionId = data.chat_session_id;
                displayOutput(data.refined_text, 'Refined Version');
                if (typeof loadChatHistory === 'function') loadChatHistory(STUDIO_TYPE);
                setInputsDisabled(true);
            } else { throw new Error(data.error); }
        } catch (error) {
            showError(error.message);
        } finally {
            resetButtonStates();
        }
    }

    async function summarizeText() {
        const text = document.getElementById('summarize-text-input').value;
        if (!text.trim()) { alert('Please paste some text to summarize.'); return; }

        const settings = {
            format: document.getElementById('summary-format').value,
            extractionType: document.getElementById('summary-extraction').value,
            focus: document.getElementById('summary-focus').value
        };

        showLoading(this, "Summarizing text...");
        try {
            const response = await fetch('/api/v1/refine/text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tool: 'summarize', text: text, settings: settings, chat_session_id: editingChatSessionId })
            });
            const data = await response.json();
            if (response.ok) {
                editingChatSessionId = data.chat_session_id;
                displayOutput(data.summary, 'Summary');
                if (typeof loadChatHistory === 'function') loadChatHistory(STUDIO_TYPE);
                setInputsDisabled(true);
            } else { throw new Error(data.error); }
        } catch (error) {
            showError(error.message);
        } finally {
            resetButtonStates();
        }
    }

    async function translateText() {
        const text = document.getElementById('translate-text-input').value;
        if (!text.trim()) { alert('Please enter text to translate.'); return; }

        const settings = {
            locale: document.getElementById('translate-locale').value,
            formality: document.querySelector('input[name="formality"]:checked').value,
            adaptIdioms: document.getElementById('translate-idioms').checked
        };

        showLoading(this, `Translating to ${settings.locale}...`);
        try {
            const response = await fetch('/api/v1/refine/text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tool: 'translate', text: text, settings: settings, chat_session_id: editingChatSessionId })
            });
            const data = await response.json();
            if (response.ok) {
                editingChatSessionId = data.chat_session_id;
                displayOutput(data.translated_text, `Translated Text (${settings.locale})`);
                if (typeof loadChatHistory === 'function') loadChatHistory(STUDIO_TYPE);
                setInputsDisabled(true);
            } else { throw new Error(data.error); }
        } catch (error) {
            showError(error.message);
        } finally {
            resetButtonStates();
        }
    }

    // --- DISPLAY & HELPER FUNCTIONS ---
    function showLoading(btn, message) {
        btn.disabled = true;
        btn.innerHTML = `<span class="material-symbols-outlined">hourglass_top</span> Generating...`;
        outputDisplay.innerHTML = `<div class="loading" style="padding: 40px; display:flex; justify-content: center; align-items: center; gap: 8px;"><div class="spinner"></div><span>${message}</span></div>`;
    }

    function showError(message) {
        outputDisplay.innerHTML = `<div class="output-card"><p style="color: red;">Error: ${message}</p></div>`;
        resetButtonStates();
    }

    function resetButtonStates() {
        const refineBtn = document.getElementById('refineTextBtn');
        const summarizeBtn = document.getElementById('summarizeBtn');
        const translateBtn = document.getElementById('translateBtn');
        if(refineBtn) {
            refineBtn.disabled = false;
            refineBtn.innerHTML = '<span class="material-symbols-outlined">auto_fix_high</span> Refine Text';
        }
        if(summarizeBtn) {
            summarizeBtn.disabled = false;
            summarizeBtn.innerHTML = '<span class="material-symbols-outlined">compress</span> Summarize';
        }
        if(translateBtn) {
            translateBtn.disabled = false;
            translateBtn.innerHTML = '<span class="material-symbols-outlined">translate</span> Translate';
        }
    }

    function displayOutput(text, title) {
        if (!text) {
            showError(`The model did not return any text for ${title}. Please try again.`);
            return;
        }
        outputDisplay.innerHTML = `
            <div class="output-card">
                <h4>${title}</h4>
                <pre class="output-content">${text.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</pre>
                <button class="btn btn-secondary" onclick="copyToClipboard(this)">Copy</button>
            </div>
        `;
    }

    window.loadSessionIntoView = async function(sessionId) {
        try {
            outputDisplay.innerHTML = `<div class="loading" style="padding: 40px; display:flex; justify-content: center; align-items: center; gap: 8px;"><div class="spinner"></div><span>Loading session...</span></div>`;
            const response = await fetch(`/api/chat-session/${sessionId}`);
            if (!response.ok) throw new Error('Failed to fetch session data.');

            const session = await response.json();
            editingChatSessionId = session.session_id;

            const userInput = JSON.parse(session.messages[0].content);

            if (session.studio_type === 'TEXT_REFINEMENT') {
                document.querySelector('.tab-button[data-tab="tone-style"]').click();
                document.getElementById('refine-text-input').value = userInput.text || '';
                document.getElementById('refine-tone').value = userInput.tone || '';
                document.getElementById('refineTextBtn').disabled = true;
                displayOutput(session.raw_text, 'Refined Version');
            } else if (session.studio_type === 'SUMMARY') {
                document.querySelector('.tab-button[data-tab="summarizer"]').click();
                document.getElementById('summarize-text-input').value = userInput.text || '';
                document.getElementById('summary-length').value = userInput.length || '';
                document.getElementById('summarizeBtn').disabled = true;
                displayOutput(session.raw_text, 'Summary');
            } else if (session.studio_type === 'TRANSLATION') {
                document.querySelector('.tab-button[data-tab="translator"]').click();
                document.getElementById('translate-text-input').value = userInput.text || '';
                document.getElementById('translate-language').value = userInput.language || '';
                document.getElementById('translateBtn').disabled = true;
                displayOutput(session.raw_text, `Translated Text (${userInput.language})`);
            }
            showNotification('Session loaded successfully!');
            setInputsDisabled(true);
        } catch (error) {
            showError(error.message);
        }
    }

    function copyToClipboard(button) {
        const content = button.previousElementSibling.textContent;
        navigator.clipboard.writeText(content).then(() => {
            button.textContent = 'Copied!';
            setTimeout(() => { button.textContent = 'Copy' }, 2000);
        }).catch(err => console.error('Copy failed', err));
    }

    function showNotification(message, type = 'success') {
        const existing = document.querySelector('.notification');
        if (existing) existing.remove();
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => notification.classList.add('show'), 100);
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
});
</script>
{% endblock %}
