<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Dashboard - InkDrive</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%234285f4'/%3E%3Cstop offset='25%25' style='stop-color:%2334a853'/%3E%3Cstop offset='50%25' style='stop-color:%23fbbc05'/%3E%3Cstop offset='100%25' style='stop-color:%23ea4335'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='24' height='24' rx='6' fill='url(%23grad)'/%3E%3Ctext x='12' y='16' text-anchor='middle' fill='white' font-family='Arial, sans-serif' font-size='14' font-weight='600'%3EI%3C/text%3E%3C/svg%3E">
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        :root {
            --primary-blue: #1a73e8;
            --primary-blue-hover: #1557b0;
            --surface: #ffffff;
            --surface-variant: #f8f9fa;
            --surface-container: #f1f3f4;
            --on-surface: #202124;
            --on-surface-variant: #5f6368;
            --outline: #dadce0;
            --outline-variant: #e8eaed;
            --success-green: #34a853;
            --warning-orange: #fbbc05;
            --error-red: #ea4335;
        }

        [data-theme="dark"] {
            --surface: #131314;
            --surface-variant: #1e1f20;
            --surface-container: #232627;
            --on-surface: #e8eaed;
            --on-surface-variant: #9aa0a6;
            --outline: #3c4043;
            --outline-variant: #5f6368;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Google Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--surface-variant);
            color: var(--on-surface);
            line-height: 1.6;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-header {
            background: var(--surface);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(45deg, #4285f4, #34a853, #fbbc05, #ea4335);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .header-info {
            flex: 1;
        }

        .user-name {
            font-size: 28px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--on-surface);
        }

        .user-email {
            color: var(--on-surface-variant);
            font-size: 16px;
            margin-bottom: 4px;
        }

        .user-meta {
            color: var(--on-surface-variant);
            font-size: 14px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            flex-shrink: 0;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-blue);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-blue-hover);
        }

        .btn-secondary {
            background: var(--surface-container);
            color: var(--on-surface);
            border: 1px solid var(--outline-variant);
        }

        .btn-secondary:hover {
            background: var(--outline);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .stat-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .stat-icon.articles {
            background: #e3f2fd;
            color: #1976d2;
        }

        .stat-icon.words {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .stat-icon.downloads {
            background: #e8f5e8;
            color: #388e3c;
        }

        .stat-icon.member {
            background: #fff3e0;
            color: #f57c00;
        }

        [data-theme="dark"] .stat-icon.articles {
            background: #1e3a8a;
            color: #bfdbfe;
        }

        [data-theme="dark"] .stat-icon.words {
            background: #581c87;
            color: #e9d5ff;
        }

        [data-theme="dark"] .stat-icon.downloads {
            background: #14532d;
            color: #bbf7d0;
        }

        [data-theme="dark"] .stat-icon.member {
            background: #9a3412;
            color: #fed7aa;
        }

        .stat-title {
            font-size: 14px;
            color: var(--on-surface-variant);
            font-weight: 500;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 600;
            color: var(--on-surface);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--on-surface-variant);
        }

        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
        }

        .content-section {
            background: var(--surface);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 500;
            color: var(--on-surface);
        }

        .section-link {
            color: var(--primary-blue);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
        }

        .section-link:hover {
            text-decoration: underline;
        }

        .article-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 0;
            border-bottom: 1px solid var(--outline-variant);
        }

        .article-item:last-child {
            border-bottom: none;
        }

        .article-icon {
            width: 40px;
            height: 40px;
            background: var(--surface-container);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--on-surface-variant);
            flex-shrink: 0;
        }

        .article-info {
            flex: 1;
            min-width: 0;
        }

        .article-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--on-surface);
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .article-meta {
            font-size: 12px;
            color: var(--on-surface-variant);
        }

        .article-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            background: var(--surface-container);
            color: var(--on-surface-variant);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: var(--outline);
            color: var(--on-surface);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--on-surface-variant);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .flash-messages {
            margin-bottom: 24px;
        }

        .flash-message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .flash-message.success {
            background: #f0fdf4;
            color: #16a34a;
            border: 1px solid #bbf7d0;
        }

        .flash-message.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .flash-message.info {
            background: #eff6ff;
            color: #2563eb;
            border: 1px solid #bfdbfe;
        }

        [data-theme="dark"] .flash-message.success {
            background: #14532d;
            color: #bbf7d0;
            border-color: #166534;
        }

        [data-theme="dark"] .flash-message.error {
            background: #7f1d1d;
            color: #fecaca;
            border-color: #991b1b;
        }

        [data-theme="dark"] .flash-message.info {
            background: #1e3a8a;
            color: #bfdbfe;
            border-color: #1d4ed8;
        }

        @media (max-width: 768px) {
            .dashboard-container {
                padding: 16px;
            }

            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 16px;
            }

            .header-actions {
                width: 100%;
                justify-content: center;
            }

            .content-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .user-name {
                font-size: 24px;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .header-actions {
                flex-direction: column;
            }
        }

        /* Add footer to dashboard */
        .footer {
            text-align: center;
            margin-top: 32px;
            padding: 16px;
            color: var(--on-surface-variant);
            font-size: 14px;
        }

        /* Fix mobile view for cards */
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 16px;
            }

            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 16px;
            }

            .header-actions {
                width: 100%;
                justify-content: center;
            }

            .content-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .user-name {
                font-size: 24px;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .header-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="flash-message {{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Profile Header -->
        <div class="dashboard-header">
            <div class="header-content">
                <div class="profile-avatar">
                    {% if user.profile_picture %}
                        <img src="{{ user.profile_picture }}" alt="{{ user.name }}">
                    {% else %}
                        {{ user.name[0].upper() }}
                    {% endif %}
                </div>
                <div class="header-info">
                    <h1 class="user-name">{{ user.name }}</h1>
                    <div class="user-email">{{ user.email }}</div>
                    <div class="user-meta">
                        Member since {{ stats.member_since }} • {{ user.subscription_tier.title() }} Plan
                    </div>
                </div>
                <div class="header-actions">
                    <a href="{{ url_for('app_main') }}" class="btn btn-primary">
                        <span class="material-symbols-outlined">edit</span>
                        Create Article
                    </a>
                    <a href="{{ url_for('profile_edit') }}" class="btn btn-secondary">
                        <span class="material-symbols-outlined">settings</span>
                        Settings
                    </a>
                    <a href="{{ url_for('auth_logout') }}" class="btn btn-secondary">
                        <span class="material-symbols-outlined">logout</span>
                        Logout
                    </a>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon articles">
                        <span class="material-symbols-outlined">article</span>
                    </div>
                    <div class="stat-title">Articles Created</div>
                </div>
                <div class="stat-value">{{ stats.total_articles }}</div>
                <div class="stat-label">Total articles generated</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon words">
                        <span class="material-symbols-outlined">text_fields</span>
                    </div>
                    <div class="stat-title">Words Written</div>
                </div>
                <div class="stat-value">{{ "{:,}".format(stats.total_words) }}</div>
                <div class="stat-label">{{ "{:,}".format(stats.words_this_month) }}/{{ "{:,}".format(stats.word_limit) }} this month</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon downloads">
                        <span class="material-symbols-outlined">download</span>
                    </div>
                    <div class="stat-title">Downloads</div>
                </div>
                <div class="stat-value">{{ stats.total_downloads }}</div>
                <div class="stat-label">{{ stats.downloads_this_month }}/{{ stats.download_limit }} this month</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon member">
                        <span class="material-symbols-outlined">schedule</span>
                    </div>
                    <div class="stat-title">Member Since</div>
                </div>
                <div class="stat-value">{{ stats.member_since.split()[1] if stats.member_since != 'Unknown' else 'N/A' }}</div>
                <div class="stat-label">{{ stats.member_since.split()[0] if stats.member_since != 'Unknown' else 'Unknown' }}</div>
            </div>
        </div>

        <!-- Content Grid -->
        <div class="content-grid">
            <!-- Recent Articles -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Recent Articles</h2>
                    <a href="{{ url_for('profile_articles') }}" class="section-link">View all</a>
                </div>

                {% if recent_articles %}
                    {% for article in recent_articles %}
                        <div class="article-item">
                            <div class="article-icon">
                                <span class="material-symbols-outlined">article</span>
                            </div>
                            <div class="article-info">
                                <div class="article-title">{{ article.title }}</div>
                                <div class="article-meta">
                                    {{ article.created_at.strftime('%b %d, %Y') }} • 
                                    {{ article.word_count }} words • 
                                    {{ article.download_count }} downloads
                                    {% if article.is_refined %}• Refined{% endif %}
                                </div>
                            </div>
                            <div class="article-actions">
                                <button class="action-btn" title="View" onclick="window.location.href='{{ url_for('article_view', article_id=article.id) }}'">
                                    <span class="material-symbols-outlined">visibility</span>
                                </button>
                                <button class="action-btn" title="Download" onclick="downloadArticle('{{ article.id }}')">
                                    <span class="material-symbols-outlined">download</span>
                                </button>
                                <button class="action-btn" title="Share" onclick="shareArticle('{{ article.public_id }}')">
                                    <span class="material-symbols-outlined">share</span>
                                </button>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">
                            <span class="material-symbols-outlined">article</span>
                        </div>
                        <p>No articles yet. <a href="{{ url_for('app_main') }}">Create your first article</a>!</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="footer">
            © InkDrive 2025 · Built by Francisj2nd
        </div>
    </div>

    <script>
        // Apply theme based on user preference
        const userTheme = '{{ user.theme_preference if user.is_authenticated else "auto" }}';
        
        function applyTheme(theme) {
            if (theme === 'dark' || (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
        }

        // Apply initial theme
        applyTheme(userTheme);

        // Listen for system theme changes if user preference is auto
        if (userTheme === 'auto') {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                applyTheme('auto');
            });
        }

        // Sync with localStorage for consistency
        localStorage.setItem('theme', userTheme);

        // Download article function - Fixed to use POST request
        async function downloadArticle(articleId) {
            try {
                const response = await fetch(`/api/articles/${articleId}/download`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Download failed');
                }

                // Handle the file download
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `article_${articleId}.docx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                alert('Failed to download article: ' + error.message);
            }
        }

        // Share article function
        function shareArticle(publicId) {
            const shareUrl = `${window.location.origin}/share/${publicId}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Check out this article',
                    url: shareUrl
                });
            } else {
                // Fallback to clipboard
                navigator.clipboard.writeText(shareUrl);
                alert('Article link copied to clipboard!');
            }
        }
    </script>
</body>
</html>
