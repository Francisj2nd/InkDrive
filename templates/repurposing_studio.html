{% extends "studio_template.html" %}

{% block title %}Content Repurposing Studio{% endblock %}

{% block studio_head_css %}
<style>
    .tabs {
        display: flex;
        border-bottom: 1px solid var(--outline);
        margin-bottom: 20px;
    }
    .tab-button {
        padding: 10px 20px;
        cursor: pointer;
        border: none;
        background: none;
        font-family: inherit;
        font-size: 14px;
        font-weight: 500;
        color: var(--on-surface-variant);
        border-bottom: 2px solid transparent;
    }
    .tab-button.active {
        color: var(--primary-blue);
        border-bottom-color: var(--primary-blue);
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    .output-card {
        background: var(--surface-variant);
        border: 1px solid var(--outline);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
    }
    .output-header {
        font-weight: bold;
        margin-bottom: 8px;
        color: var(--on-surface-variant);
    }
    .output-content {
        white-space: pre-wrap;
        font-family: inherit;
        font-size: 14px;
        color: var(--on-surface);
    }
    .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid var(--outline);
        border-top: 2px solid var(--primary-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block studio_title %}Content Repurposing Studio{% endblock %}
{% block studio_description %}Turn one piece of content into many, like an article into a Twitter thread or a blog post into a presentation.{% endblock %}

{% block studio_inputs %}
<div class="form-group">
    <label for="repurpose-text-input">Original Content</label>
    <textarea id="repurpose-text-input" class="form-control" rows="8" placeholder="Paste your article, blog post, or any other text here..."></textarea>
</div>

<div class="form-group">
    <label for="repurpose-into">Repurpose Into</label>
    <select id="repurpose-into" class="form-control">
        <option value="twitter_thread">Twitter Thread</option>
        <option value="linkedin_post">LinkedIn Post</option>
        <option value="video_script">Video Script</option>
    </select>
</div>

<hr>

<!-- Universal Settings -->
<div class="form-group">
    <label for="repurpose-audience">Target Audience for New Content</label>
    <input type="text" id="repurpose-audience" class="form-control" placeholder="e.g., Marketing professionals, tech enthusiasts">
</div>
<div class="form-group">
    <label for="repurpose-goal">Goal of Repurposed Content</label>
    <select id="repurpose-goal" class="form-control">
        <option>Drive traffic</option>
        <option>Increase engagement</option>
        <option>Build authority</option>
        <option>Inform and educate</option>
    </select>
</div>
<div class="form-group">
    <label for="repurpose-message">Key Message to Emphasize (Optional)</label>
    <input type="text" id="repurpose-message" class="form-control" placeholder="e.g., The importance of sustainable packaging">
</div>

<!-- Dynamic Settings Sections -->
<div id="dynamic-settings-container">
    <div class="dynamic-settings" id="settings-twitter_thread" style="display: block;">
        <h5>Twitter Thread Settings</h5>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="twitter-tweets-count">Number of Tweets</label>
                    <input type="number" id="twitter-tweets-count" class="form-control" value="5" min="2" max="15">
                </div>
            </div>
            <div class="col-md-6">
                <label>&nbsp;</label>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="twitter-hook" checked>
                    <label class="form-check-label" for="twitter-hook">Include engaging hook</label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="twitter-hashtags" checked>
                    <label class="form-check-label" for="twitter-hashtags">Include hashtags</label>
                </div>
            </div>
        </div>
    </div>

    <div class="dynamic-settings" id="settings-linkedin_post" style="display: none;">
        <h5>LinkedIn Post Settings</h5>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="linkedin-professional-tone" checked>
            <label class="form-check-label" for="linkedin-professional-tone">Use a professional tone</label>
        </div>
    </div>

    <div class="dynamic-settings" id="settings-video_script" style="display: none;">
        <h5>Video Script Settings</h5>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="video-length">Target Length</label>
                    <select id="video-length" class="form-control">
                        <option>1-2 minutes</option>
                        <option>3-5 minutes</option>
                        <option>5-10 minutes</option>
                    </select>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="video-speaker">Spoken By</label>
                    <select id="video-speaker" class="form-control">
                        <option>Single narrator</option>
                        <option>Two hosts (dialogue)</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="video-cues" checked>
            <label class="form-check-label" for="video-cues">Include visual cues</label>
        </div>
    </div>
</div>

<div style="display: flex; gap: 12px; margin-top: 20px;">
    <button id="newSessionBtn" class="btn btn-secondary">
        <span class="material-symbols-outlined">add</span>
        New Session
    </button>
    <button id="repurposeBtn" class="btn btn-primary" style="flex-grow: 1;">
        <span class="material-symbols-outlined">repeat</span>
        Repurpose Content
    </button>
</div>
{% endblock %}

{% block studio_output %}
<div id="repurposing-output-display">
    <div class="empty-state">
        <span class="material-symbols-outlined" style="font-size: 48px;">transform</span>
        <p>Your repurposed content will appear here.</p>
    </div>
</div>
{% endblock %}

{% block studio_scripts %}
<script>
    const STUDIO_TYPE = 'repurpose';
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- COMMON ELEMENTS ---
    const outputDisplay = document.getElementById('repurposing-output-display');
    const repurposeIntoSelect = document.getElementById('repurpose-into');
    const dynamicSettingsContainer = document.getElementById('dynamic-settings-container');
    const repurposeBtn = document.getElementById('repurposeBtn');
    let repurposeChatSessionId = null;

    // --- DYNAMIC SETTINGS LOGIC ---
    repurposeIntoSelect.addEventListener('change', function() {
        // Hide all dynamic settings
        const allSettings = dynamicSettingsContainer.querySelectorAll('.dynamic-settings');
        allSettings.forEach(s => s.style.display = 'none');

        // Show the selected one
        const selectedSettingsId = `settings-${this.value}`;
        const selectedSettings = document.getElementById(selectedSettingsId);
        if (selectedSettings) {
            selectedSettings.style.display = 'block';
        }
    });

    // --- EVENT LISTENER ---
    repurposeBtn?.addEventListener('click', repurposeContent);
    document.getElementById('newSessionBtn')?.addEventListener('click', startNewSession);

    // --- HELPER FUNCTIONS ---
    function setInputsDisabled(disabled) {
        document.getElementById('repurpose-text-input').disabled = disabled;
        document.getElementById('repurpose-into').disabled = disabled;
        document.getElementById('repurpose-audience').disabled = disabled;
        document.getElementById('repurpose-goal').disabled = disabled;
        document.getElementById('repurpose-message').disabled = disabled;
        document.getElementById('twitter-tweets-count').disabled = disabled;
        document.getElementById('twitter-hook').disabled = disabled;
        document.getElementById('twitter-hashtags').disabled = disabled;
        document.getElementById('linkedin-professional-tone').disabled = disabled;
        document.getElementById('video-length').disabled = disabled;
        document.getElementById('video-speaker').disabled = disabled;
        document.getElementById('video-cues').disabled = disabled;
        repurposeBtn.disabled = disabled;
    }

    function startNewSession() {
        setInputsDisabled(false);
        document.getElementById('repurpose-text-input').value = '';
        outputDisplay.innerHTML = `<div class="empty-state"><span class="material-symbols-outlined" style="font-size: 48px;">transform</span><p>Your repurposed content will appear here.</p></div>`;
        repurposeChatSessionId = null;
        showNotification('New session started.', 'success');
    }

    // --- API FUNCTION ---
    async function repurposeContent() {
        const originalContent = document.getElementById('repurpose-text-input').value;
        if (!originalContent.trim()) {
            alert('Please paste the original content.');
            return;
        }

        const repurposeType = repurposeIntoSelect.value;

        // Gather universal settings
        const settings = {
            audience: document.getElementById('repurpose-audience').value,
            goal: document.getElementById('repurpose-goal').value,
            message: document.getElementById('repurpose-message').value,
        };

        // Gather format-specific settings
        if (repurposeType === 'twitter_thread') {
            settings.tweetCount = document.getElementById('twitter-tweets-count').value;
            settings.includeHook = document.getElementById('twitter-hook').checked;
            settings.includeHashtags = document.getElementById('twitter-hashtags').checked;
        } else if (repurposeType === 'video_script') {
            settings.targetLength = document.getElementById('video-length').value;
            settings.spokenBy = document.getElementById('video-speaker').value;
            settings.includeVisualCues = document.getElementById('video-cues').checked;
        } else if (repurposeType === 'linkedin_post') {
            settings.useProfessionalTone = document.getElementById('linkedin-professional-tone').checked;
        }

        showLoading(this, "Repurposing your content...");
        try {
            const response = await fetch('/api/v1/repurpose/content', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    tool: repurposeType,
                    text: originalContent,
                    settings: settings,
                    chat_session_id: repurposeChatSessionId
                })
            });
            const data = await response.json();
            if (response.ok) {
                repurposeChatSessionId = data.chat_session_id;
                // A generic display function can handle different outputs
                displayOutput(data.result, `Repurposed into: ${repurposeIntoSelect.options[repurposeIntoSelect.selectedIndex].text}`);
                if (typeof loadChatHistory === 'function') loadChatHistory(STUDIO_TYPE);
                setInputsDisabled(true);
            } else {
                throw new Error(data.error);
            }
        } catch (error) {
            showError(error.message);
        } finally {
            resetButton(this, 'repeat', 'Repurpose Content');
        }
    }

    // --- DISPLAY & HELPER FUNCTIONS ---
    function showLoading(btn, message) {
        btn.disabled = true;
        btn.innerHTML = `<span class="material-symbols-outlined">hourglass_top</span> Generating...`;
        outputDisplay.innerHTML = `<div class="loading" style="padding: 40px; display:flex; justify-content: center; align-items: center; gap: 8px;"><div class="spinner"></div><span>${message}</span></div>`;
    }

    function showError(message) {
        outputDisplay.innerHTML = `<div class="output-card"><p style="color: red;">Error: ${message}</p></div>`;
        resetButton(repurposeBtn, 'repeat', 'Repurpose Content');
    }

    function resetButton(btn, icon, text) {
        if(btn) {
            btn.disabled = false;
            btn.innerHTML = `<span class="material-symbols-outlined">${icon}</span> ${text}`;
        }
    }

    function displayOutput(text, title) {
        const content = text.split('---').map(t => t.trim()).filter(t => t);
        if (content.length > 1) {
             outputDisplay.innerHTML = content.map((item, index) => `
                <div class="output-card"><div class="output-header">${title} - Part ${index + 1}</div><pre class="output-content">${escapeHtml(item)}</pre><button class="btn btn-secondary" style="font-size: 12px; padding: 4px 12px; margin-top: 12px;" onclick="copyToClipboard(this)">Copy</button></div>
            `).join('');
        } else {
            outputDisplay.innerHTML = `<div class="output-card"><div class="output-header">${title}</div><pre class="output-content">${escapeHtml(text)}</pre></div>`;
        }
    }

    function escapeHtml(unsafe) {
        return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    function copyToClipboard(button) {
        const content = button.previousElementSibling.textContent;
        navigator.clipboard.writeText(content).then(() => {
            button.textContent = 'Copied!';
            setTimeout(() => { button.textContent = 'Copy' }, 2000);
        }).catch(err => console.error('Copy failed', err));
    }

    function showNotification(message, type = 'success') {
        const existing = document.querySelector('.notification');
        if (existing) existing.remove();
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => notification.classList.add('show'), 100);
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
});
</script>
{% endblock %}
