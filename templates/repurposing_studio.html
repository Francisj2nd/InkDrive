{% extends "studio_template.html" %}

{% block title %}Content Repurposing Studio{% endblock %}

{% block studio_head_css %}
<style>
    .tabs {
        display: flex;
        border-bottom: 1px solid var(--outline);
        margin-bottom: 20px;
    }
    .tab-button {
        padding: 10px 20px;
        cursor: pointer;
        border: none;
        background: none;
        font-family: inherit;
        font-size: 14px;
        font-weight: 500;
        color: var(--on-surface-variant);
        border-bottom: 2px solid transparent;
    }
    .tab-button.active {
        color: var(--primary-blue);
        border-bottom-color: var(--primary-blue);
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    .output-card {
        background: var(--surface-variant);
        border: 1px solid var(--outline);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
    }
    .output-header {
        font-weight: bold;
        margin-bottom: 8px;
        color: var(--on-surface-variant);
    }
    .output-content {
        white-space: pre-wrap;
        font-family: inherit;
        font-size: 14px;
        color: var(--on-surface);
    }
    .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid var(--outline);
        border-top: 2px solid var(--primary-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block studio_title %}Content Repurposing Studio{% endblock %}
{% block studio_description %}Turn one piece of content into many, like an article into a Twitter thread or a blog post into a presentation.{% endblock %}

{% block studio_inputs %}
<div class="tabs">
    <button class="tab-button active" data-tab="article-to-tweet">Article to Twitter Thread</button>
    <button class="tab-button" data-tab="blog-to-slides">Blog to Presentation</button>
</div>

<div id="article-to-tweet" class="tab-content active">
    <div class="form-group">
        <label for="repurpose-article-input">Full Article Text</label>
        <textarea id="repurpose-article-input" class="form-control" rows="12" placeholder="Paste your full article here..."></textarea>
    </div>
    <button id="repurposeTweetBtn" class="btn btn-primary" style="width: 100%;">
        <span class="material-symbols-outlined">repeat</span>
        Generate Twitter Thread
    </button>
</div>

<div id="blog-to-slides" class="tab-content">
    <div class="form-group">
        <label for="repurpose-blog-input">Full Blog Post Text</label>
        <textarea id="repurpose-blog-input" class="form-control" rows="12" placeholder="Paste your full blog post here..."></textarea>
    </div>
    <button id="repurposeSlidesBtn" class="btn btn-primary" style="width: 100%;">
        <span class="material-symbols-outlined">slideshow</span>
        Generate Presentation Outline
    </button>
</div>
{% endblock %}

{% block studio_output %}
<div id="repurposing-output-display">
    <div class="empty-state">
        <span class="material-symbols-outlined" style="font-size: 48px;">transform</span>
        <p>Your repurposed content will appear here.</p>
    </div>
</div>
{% endblock %}

{% block studio_scripts %}
<script>
    const STUDIO_TYPE = 'repurpose';
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- COMMON ELEMENTS ---
    const outputDisplay = document.getElementById('repurposing-output-display');
    let repurposeChatSessionId = null;

    // --- TAB SWITCHING ---
    const tabs = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(tab.dataset.tab).classList.add('active');
            outputDisplay.innerHTML = `<div class="empty-state"><span class="material-symbols-outlined" style="font-size: 48px;">transform</span><p>Your repurposed content will appear here.</p></div>`;
        });
    });

    // --- EVENT LISTENERS ---
    document.getElementById('repurposeTweetBtn')?.addEventListener('click', generateTweetThread);
    document.getElementById('repurposeSlidesBtn')?.addEventListener('click', generateSlides);

    // --- API FUNCTIONS ---
    async function generateTweetThread() {
        const articleText = document.getElementById('repurpose-article-input').value;
        if (!articleText.trim()) { alert('Please paste the article text.'); return; }

        showLoading(this, "Brewing your Twitter thread...");
        try {
            const response = await fetch('/api/v1/repurpose/content', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tool: 'tweet_thread', text: articleText, chat_session_id: repurposeChatSessionId })
            });
            const data = await response.json();
            if (response.ok) {
                repurposeChatSessionId = data.chat_session_id;
                displayTweetThread(data.result);
                if (typeof loadChatHistory === 'function') loadChatHistory(STUDIO_TYPE);
            } else { throw new Error(data.error); }
        } catch (error) {
            showError(error.message);
        } finally {
            resetButtonStates();
        }
    }

    async function generateSlides() {
        const blogText = document.getElementById('repurpose-blog-input').value;
        if (!blogText.trim()) { alert('Please paste the blog post text.'); return; }

        showLoading(this, "Outlining your presentation...");
        try {
            const response = await fetch('/api/v1/repurpose/content', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tool: 'presentation', text: blogText, chat_session_id: repurposeChatSessionId })
            });
            const data = await response.json();
            if (response.ok) {
                repurposeChatSessionId = data.chat_session_id;
                displaySlides(data.result);
                if (typeof loadChatHistory === 'function') loadChatHistory(STUDIO_TYPE);
            } else { throw new Error(data.error); }
        } catch (error) {
            showError(error.message);
        } finally {
            resetButtonStates();
        }
    }

    // --- DISPLAY & HELPER FUNCTIONS ---
    function showLoading(btn, message) {
        btn.disabled = true;
        btn.innerHTML = `<span class="material-symbols-outlined">hourglass_top</span> Generating...`;
        outputDisplay.innerHTML = `<div class="loading" style="padding: 40px; display:flex; justify-content: center; align-items: center; gap: 8px;"><div class="spinner"></div><span>${message}</span></div>`;
    }

    function showError(message) {
        outputDisplay.innerHTML = `<div class="output-card"><p style="color: red;">Error: ${message}</p></div>`;
        resetButtonStates();
    }

    function resetButtonStates() {
        const tweetBtn = document.getElementById('repurposeTweetBtn');
        const slidesBtn = document.getElementById('repurposeSlidesBtn');
        if(tweetBtn) {
            tweetBtn.disabled = false;
            tweetBtn.innerHTML = '<span class="material-symbols-outlined">repeat</span> Generate Twitter Thread';
        }
        if(slidesBtn) {
            slidesBtn.disabled = false;
            slidesBtn.innerHTML = '<span class="material-symbols-outlined">slideshow</span> Generate Presentation Outline';
        }
    }

    function displayTweetThread(threadText) {
        const tweets = threadText.split('---').map(t => t.trim()).filter(t => t);
        outputDisplay.innerHTML = tweets.map((tweet, index) => `
            <div class="output-card"><div class="output-header">Tweet ${index + 1} of ${tweets.length}</div><pre class="output-content">${escapeHtml(tweet)}</pre><button class="btn btn-secondary" style="font-size: 12px; padding: 4px 12px; margin-top: 12px;" onclick="copyToClipboard(this)">Copy Tweet</button></div>
        `).join('');
    }

    function displaySlides(slidesText) {
        outputDisplay.innerHTML = `<div class="output-card"><div class="output-header">Presentation Outline</div><pre class="output-content">${escapeHtml(slidesText)}</pre></div>`;
    }

    window.loadSessionIntoView = async function(sessionId) {
        try {
            showLoadingState("Loading session...");
            const response = await fetch(`/api/chat-session/${sessionId}`);
            if (!response.ok) throw new Error('Failed to fetch session data.');

            const session = await response.json();
            repurposeChatSessionId = session.session_id;

            if (session.studio_type === 'REPURPOSE_TWEET') {
                document.querySelector('.tab-button[data-tab="article-to-tweet"]').click();
                displayTweetThread(session.raw_text);
            } else if (session.studio_type === 'REPURPOSE_SLIDES') {
                document.querySelector('.tab-button[data-tab="blog-to-slides"]').click();
                displaySlides(session.raw_text);
            }
            showNotification('Session loaded successfully!');
        } catch (error) {
            showError(error.message);
        }
    }

    function copyToClipboard(button) {
        const content = button.previousElementSibling.textContent;
        navigator.clipboard.writeText(content).then(() => {
            button.textContent = 'Copied!';
            setTimeout(() => { button.textContent = 'Copy' }, 2000);
        }).catch(err => console.error('Copy failed', err));
    }

    function escapeHtml(unsafe) {
        return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    function showNotification(message, type = 'success') {
        const existing = document.querySelector('.notification');
        if (existing) existing.remove();
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => notification.classList.add('show'), 100);
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
});
</script>
{% endblock %}
