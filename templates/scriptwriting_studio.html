{% extends "studio_template.html" %}

{% block title %}Scriptwriting Studio{% endblock %}

{% block studio_head_css %}
<style>
    .output-card {
        background: var(--surface-variant);
        border: 1px solid var(--outline);
        border-radius: 8px;
        padding: 16px;
        margin-top: 16px;
    }
    .output-card h4 {
        margin-top: 0;
        margin-bottom: 12px;
        font-weight: 500;
    }
    .output-content {
        white-space: pre-wrap;
        font-family: inherit;
        font-size: 14px;
        color: var(--on-surface);
    }
    .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid var(--outline);
        border-top: 2px solid var(--primary-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block studio_title %}Scriptwriting Studio{% endblock %}
{% block studio_description %}Generate scripts for YouTube, TikTok, and other video platforms.{% endblock %}

{% block studio_inputs %}
<div class="form-group">
    <label for="script-topic">Core Topic or Premise</label>
    <input type="text" id="script-topic" class="form-control" placeholder="e.g., A review of the latest flagship smartphone">
</div>

<div class="form-group">
    <label for="script-format">Script Format</label>
    <select id="script-format" class="form-control">
        <option value="youtube_video" selected>YouTube Video</option>
        <option value="tiktok_shorts">TikTok/Shorts</option>
        <option value="podcast_episode">Podcast Episode</option>
    </select>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="form-group">
            <label for="script-audience">Target Audience</label>
            <input type="text" id="script-audience" class="form-control" placeholder="e.g., Tech enthusiasts, beginner photographers">
        </div>
    </div>
    <div class="col-md-6">
        <div class="form-group">
            <label for="script-tone">Tone / Style</label>
            <input type="text" id="script-tone" class="form-control" placeholder="e.g., Energetic and witty, calm and informative">
        </div>
    </div>
</div>

<div class="form-group">
    <label for="script-characters">Characters / Hosts</label>
    <textarea id="script-characters" class="form-control" rows="2" placeholder="e.g., Alex (main host), Ben (technical expert)"></textarea>
    <small class="form-text text-muted">Define the speakers in the script. Use a new line for each.</small>
</div>

<div class="form-group">
    <label>Structural Elements</label>
    <div class="checkbox-grid">
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="struct-hook" value="hook" checked>
            <label class="form-check-label" for="struct-hook">Engaging Hook</label>
        </div>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="struct-cta" value="cta" checked>
            <label class="form-check-label" for="struct-cta">Call to Action</label>
        </div>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="struct-ad" value="ad_break">
            <label class="form-check-label" for="struct-ad">Ad Break Slot</label>
        </div>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="struct-visuals" value="visual_cues" checked>
            <label class="form-check-label" for="struct-visuals">Visual Cues</label>
        </div>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="struct-sfx" value="sfx">
            <label class="form-check-label" for="struct-sfx">Sound Effects</label>
        </div>
    </div>
</div>


<div style="display: flex; gap: 12px; margin-top: 20px;">
    <button id="newSessionBtn" class="btn btn-secondary">
        <span class="material-symbols-outlined">add</span>
        New Session
    </button>
    <button id="generateScriptBtn" class="btn btn-primary" style="flex-grow: 1;">
        <span class="material-symbols-outlined">movie</span>
        Generate Script
    </button>
</div>
{% endblock %}

{% block studio_output %}
<div id="script-output-display">
    <div class="empty-state">
        <span class="material-symbols-outlined" style="font-size: 48px;">movie</span>
        <p>Your generated script will appear here.</p>
    </div>
</div>
{% endblock %}

{% block studio_scripts %}
<script>
    const STUDIO_TYPE = 'scriptwriting';
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generateScriptBtn');
    const outputDisplay = document.getElementById('script-output-display');
    let scriptChatSessionId = null;

    document.getElementById('newSessionBtn')?.addEventListener('click', startNewSession);

    function setInputsDisabled(disabled) {
        document.getElementById('script-topic').disabled = disabled;
        document.getElementById('script-format').disabled = disabled;
        document.getElementById('script-audience').disabled = disabled;
        document.getElementById('script-tone').disabled = disabled;
        document.getElementById('script-characters').disabled = disabled;
        document.querySelectorAll('.checkbox-grid input').forEach(el => el.disabled = disabled);
        generateBtn.disabled = disabled;
    }

    function startNewSession() {
        setInputsDisabled(false);
        document.getElementById('script-topic').value = '';
        document.getElementById('script-audience').value = '';
        document.getElementById('script-tone').value = '';
        document.getElementById('script-characters').value = '';
        outputDisplay.innerHTML = `<div class="empty-state"><span class="material-symbols-outlined" style="font-size: 48px;">movie</span><p>Your generated script will appear here.</p></div>`;
        scriptChatSessionId = null;
        generateBtn.innerHTML = '<span class="material-symbols-outlined">movie</span> Generate Script';
        if (typeof showNotification === 'function') {
            showNotification('New session started.', 'success');
        }
    }

    if (generateBtn) {
        generateBtn.addEventListener('click', async () => {
            const topic = document.getElementById('script-topic').value;
            if (!topic.trim()) {
                alert('Please enter a core topic or premise.');
                return;
            }

            const settings = {
                format: document.getElementById('script-format').value,
                audience: document.getElementById('script-audience').value,
                tone: document.getElementById('script-tone').value,
                characters: document.getElementById('script-characters').value,
                structural_elements: Array.from(document.querySelectorAll('.checkbox-grid input:checked')).map(el => el.value)
            };

            generateBtn.disabled = true;
            generateBtn.innerHTML = `<span class="material-symbols-outlined">hourglass_top</span> Generating...`;
            outputDisplay.innerHTML = `<div class="loading" style="padding: 40px; display:flex; justify-content: center; align-items: center; gap: 8px;"><div class="spinner"></div><span>Writing your script...</span></div>`;

            try {
                const response = await fetch('/api/v1/generate/script', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic: topic,
                        settings: settings,
                        chat_session_id: scriptChatSessionId
                    })
                });
                const data = await response.json();

                if (response.ok) {
                    scriptChatSessionId = data.chat_session_id;
                    displayScript(data.script, settings.format);
                    if (typeof loadChatHistory === 'function') {
                        loadChatHistory(STUDIO_TYPE);
                    }
                    setInputsDisabled(true);
                } else {
                    throw new Error(data.error || 'Failed to generate script');
                }
            } catch (error) {
                outputDisplay.innerHTML = `<div class="output-card"><p style="color: red;">Error: ${error.message}</p></div>`;
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<span class="material-symbols-outlined">movie</span> Generate Script';
            }
        });
    }

    function displayScript(scriptText, format) {
        if (!scriptText) {
            outputDisplay.innerHTML = '<div class="output-card"><p>The model did not return a script. Please try again.</p></div>';
            return;
        }

        const title = format.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) + " Script";

        outputDisplay.innerHTML = `
            <div class="output-card">
                <h4>${title}</h4>
                <pre class="output-content">${scriptText.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</pre>
            </div>
        `;
    }

    window.loadSessionIntoView = async function(sessionId) {
        try {
            outputDisplay.innerHTML = `<div class="loading" style="padding: 40px; display:flex; justify-content: center; align-items: center; gap: 8px;"><div class="spinner"></div><span>Loading session...</span></div>`;
            const response = await fetch(`/api/chat-session/${sessionId}`);
            if (!response.ok) throw new Error('Failed to fetch session data.');

            const session = await response.json();
            scriptChatSessionId = session.session_id;

            // The first message contains the original user input
            const userInput = JSON.parse(session.messages[0].content);
            const settings = userInput.settings || {};

            document.getElementById('script-topic').value = userInput.topic || '';
            document.getElementById('script-format').value = settings.format || 'youtube_video';
            document.getElementById('script-audience').value = settings.audience || '';
            document.getElementById('script-tone').value = settings.tone || '';
            document.getElementById('script-characters').value = settings.characters || '';

            // Reset all checkboxes
            document.querySelectorAll('.checkbox-grid input[type="checkbox"]').forEach(cb => cb.checked = false);
            // Check the ones from the loaded session
            if (settings.structural_elements && Array.isArray(settings.structural_elements)) {
                settings.structural_elements.forEach(val => {
                    const cb = document.querySelector(`.checkbox-grid input[value="${val}"]`);
                    if (cb) cb.checked = true;
                });
            }

            document.getElementById('generateScriptBtn').disabled = true;

            displayScript(session.raw_text, settings.format || 'youtube_video');

            if (typeof showNotification === 'function') {
                showNotification('Session loaded successfully!');
            }

        } catch (error) {
            outputDisplay.innerHTML = `<div class="output-card"><p style="color: red;">Error: ${error.message}</p></div>`;
        }
    }
});
</script>
{% endblock %}
