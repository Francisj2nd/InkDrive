{% extends "studio_template.html" %}

{% block title %}SEO Strategy Studio{% endblock %}

{% block studio_head_css %}
<style>
    .tabs {
        display: flex;
        border-bottom: 1px solid var(--outline);
        margin-bottom: 20px;
    }
    .tab-button {
        padding: 10px 20px;
        cursor: pointer;
        border: none;
        background: none;
        font-family: inherit;
        font-size: 14px;
        font-weight: 500;
        color: var(--on-surface-variant);
        border-bottom: 2px solid transparent;
    }
    .tab-button.active {
        color: var(--primary-blue);
        border-bottom-color: var(--primary-blue);
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    .output-card {
        background: var(--surface-variant);
        border: 1px solid var(--outline);
        border-radius: 8px;
        padding: 16px;
        margin-top: 16px;
    }
    .output-card h4 {
        margin-top: 0;
        margin-bottom: 12px;
        font-weight: 500;
    }
    .output-list {
        padding-left: 20px;
        margin: 0;
    }
    .output-list li {
        margin-bottom: 8px;
        font-size: 15px;
    }
    .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid var(--outline);
        border-top: 2px solid var(--primary-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block studio_title %}SEO Strategy Studio{% endblock %}
{% block studio_description %}Generate keywords, analyze headlines, and build a content strategy.{% endblock %}

{% block studio_inputs %}
<div style="display: flex; gap: 12px; margin-bottom: 20px;">
    <button id="newSessionBtn" class="btn btn-secondary" style="width: 100%;">
        <span class="material-symbols-outlined">add</span>
        New Session
    </button>
</div>
<div class="tabs">
    <button class="tab-button active" data-tab="keyword-strategy">Keyword Strategy</button>
    <button class="tab-button" data-tab="on-page-audit">On-Page SEO Audit</button>
</div>

<div id="keyword-strategy" class="tab-content active">
    <div class="form-group">
        <label for="business-description">Business/Product Description</label>
        <textarea id="business-description" class="form-control" rows="3" placeholder="e.g., We sell eco-friendly, handmade soaps for sensitive skin."></textarea>
    </div>
    <div class="form-group">
        <label for="target-audience">Target Audience</label>
        <input type="text" id="target-audience" class="form-control" placeholder="e.g., Environmentally conscious millennials">
    </div>
    <div class="form-group">
        <label>Search Intent Focus</label>
        <div class="d-flex flex-wrap gap-3">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="intent-informational" name="intent" value="Informational" checked>
                <label class="form-check-label" for="intent-informational">Informational</label>
            </div>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="intent-commercial" name="intent" value="Commercial">
                <label class="form-check-label" for="intent-commercial">Commercial</label>
            </div>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="intent-transactional" name="intent" value="Transactional">
                <label class="form-check-label" for="intent-transactional">Transactional</label>
            </div>
        </div>
    </div>
    <div class="form-group">
        <label for="competitor-domains">Competitor Domains (Optional, one per line)</label>
        <textarea id="competitor-domains" class="form-control" rows="2" placeholder="e.g., lush.com&#x0a;drsquatch.com"></textarea>
    </div>
    <button id="generateKeywordsBtn" class="btn btn-primary" style="width: 100%;">
        <span class="material-symbols-outlined">key</span>
        Generate Keyword Strategy
    </button>
</div>

<div id="on-page-audit" class="tab-content">
    <div class="form-group">
        <label for="audit-url">Page URL to Audit</label>
        <input type="text" id="audit-url" class="form-control" placeholder="https://example.com/your-page-to-audit">
    </div>
     <div class="form-group">
        <label for="primary-keyword">Primary Target Keyword</label>
        <input type="text" id="primary-keyword" class="form-control" placeholder="e.g., 'handmade sensitive skin soap'" required>
    </div>
    <div class="form-group">
        <label for="secondary-keywords">Secondary Keywords (Optional, comma-separated)</label>
        <input type="text" id="secondary-keywords" class="form-control" placeholder="e.g., 'natural soap', 'oatmeal soap for eczema'">
    </div>
    <div class="form-group">
        <label for="page-goal">Page Goal / Call-to-Action</label>
        <input type="text" id="page-goal" class="form-control" placeholder="e.g., 'User clicks buy now on the featured soap'">
    </div>
    <div class="form-group">
        <label for="competitor-url">Competitor URL to Outrank (Optional)</label>
        <input type="text" id="competitor-url" class="form-control" placeholder="https://competitor.com/their-soap-page">
    </div>
    <button id="runAuditBtn" class="btn btn-primary" style="width: 100%;">
        <span class="material-symbols-outlined">pageview</span>
        Run On-Page Audit
    </button>
</div>
{% endblock %}

{% block studio_output %}
<div id="seo-output-display">
    <div class="empty-state">
        <span class="material-symbols-outlined" style="font-size: 48px;">trending_up</span>
        <p>Your SEO insights will appear here.</p>
    </div>
</div>
{% endblock %}

{% block studio_scripts %}
<script>
    const STUDIO_TYPE = 'seo';
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- COMMON ELEMENTS ---
    const outputDisplay = document.getElementById('seo-output-display');
    let seoChatSessionId = null; // Shared session for this studio

    // --- TAB SWITCHING ---
    const tabs = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(tab.dataset.tab).classList.add('active');
            // Clear output when switching tabs
            outputDisplay.innerHTML = `
                <div class="empty-state">
                    <span class="material-symbols-outlined" style="font-size: 48px;">trending_up</span>
                    <p>Your SEO insights will appear here.</p>
                </div>`;
        });
    });

    // --- HELPER FUNCTIONS ---
    function setInputsDisabled(disabled) {
        // Keyword Strategy
        document.getElementById('business-description').disabled = disabled;
        document.getElementById('target-audience').disabled = disabled;
        document.querySelectorAll('input[name="intent"]').forEach(i => i.disabled = disabled);
        document.getElementById('competitor-domains').disabled = disabled;
        document.getElementById('generateKeywordsBtn').disabled = disabled;

        // On-Page Audit
        document.getElementById('audit-url').disabled = disabled;
        document.getElementById('primary-keyword').disabled = disabled;
        document.getElementById('secondary-keywords').disabled = disabled;
        document.getElementById('page-goal').disabled = disabled;
        document.getElementById('competitor-url').disabled = disabled;
        document.getElementById('runAuditBtn').disabled = disabled;
    }

    function startNewSession() {
        setInputsDisabled(false);
        // Clear inputs
        document.getElementById('business-description').value = '';
        document.getElementById('target-audience').value = '';
        document.getElementById('competitor-domains').value = '';
        document.getElementById('audit-url').value = '';
        document.getElementById('primary-keyword').value = '';
        document.getElementById('secondary-keywords').value = '';
        document.getElementById('page-goal').value = '';
        document.getElementById('competitor-url').value = '';

        outputDisplay.innerHTML = `<div class="empty-state"><span class="material-symbols-outlined" style="font-size: 48px;">trending_up</span><p>Your SEO insights will appear here.</p></div>`;
        seoChatSessionId = null;
        if (typeof showNotification === 'function') {
            showNotification('New session started.', 'success');
        }
    }

    // --- KEYWORD STRATEGY LOGIC ---
    const generateKeywordsBtn = document.getElementById('generateKeywordsBtn');
    if (generateKeywordsBtn) {
        generateKeywordsBtn.addEventListener('click', async () => {
            const settings = {
                description: document.getElementById('business-description').value,
                audience: document.getElementById('target-audience').value,
                intents: Array.from(document.querySelectorAll('input[name="intent"]:checked')).map(cb => cb.value),
                competitors: document.getElementById('competitor-domains').value
            };

            if (!settings.description.trim() || !settings.audience.trim()) {
                alert('Please provide a business description and target audience.');
                return;
            }

            generateKeywordsBtn.disabled = true;
            generateKeywordsBtn.innerHTML = `<span class="material-symbols-outlined">hourglass_top</span> Generating...`;
            showLoadingState("Building keyword strategy...");

            try {
                const response = await fetch('/api/v1/seo/tools', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tool: 'keyword_strategy',
                        settings: settings,
                        chat_session_id: seoChatSessionId
                    })
                });
                const data = await response.json();

                if (response.ok) {
                    seoChatSessionId = data.chat_session_id;
                    displayKeywords(data.keywords);
                    if (typeof loadChatHistory === 'function') loadChatHistory(STUDIO_TYPE);
                    setInputsDisabled(true);
                } else {
                    throw new Error(data.error || 'Failed to generate keyword strategy');
                }
            } catch (error) {
                showErrorState(error.message);
            } finally {
                generateKeywordsBtn.disabled = false;
                generateKeywordsBtn.innerHTML = '<span class="material-symbols-outlined">key</span> Generate Keyword Strategy';
            }
        });
    }

    // --- ON-PAGE SEO AUDIT LOGIC ---
    const runAuditBtn = document.getElementById('runAuditBtn');
    if (runAuditBtn) {
        runAuditBtn.addEventListener('click', async () => {
            const settings = {
                url: document.getElementById('audit-url').value,
                primaryKeyword: document.getElementById('primary-keyword').value,
                secondaryKeywords: document.getElementById('secondary-keywords').value,
                pageGoal: document.getElementById('page-goal').value,
                competitorUrl: document.getElementById('competitor-url').value
            };

            if (!settings.url.trim() || !settings.primaryKeyword.trim()) {
                alert('Please provide a URL and a primary keyword for the audit.');
                return;
            }

            runAuditBtn.disabled = true;
            runAuditBtn.innerHTML = `<span class="material-symbols-outlined">hourglass_top</span> Running Audit...`;
            showLoadingState("Auditing your page...");

            try {
                const response = await fetch('/api/v1/seo/tools', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tool: 'on_page_audit',
                        settings: settings,
                        chat_session_id: seoChatSessionId
                    })
                });
                const data = await response.json();

                if (response.ok) {
                    seoChatSessionId = data.chat_session_id;
                    displayAudit(data.audit_results);
                    if (typeof loadChatHistory === 'function') loadChatHistory(STUDIO_TYPE);
                    setInputsDisabled(true);
                } else {
                    throw new Error(data.error || 'Failed to run audit');
                }
            } catch (error) {
                showErrorState(error.message);
            } finally {
                runAuditBtn.disabled = false;
                runAuditBtn.innerHTML = '<span class="material-symbols-outlined">pageview</span> Run On-Page Audit';
            }
        });
    }

    document.getElementById('newSessionBtn')?.addEventListener('click', startNewSession);

    // --- DISPLAY FUNCTIONS ---
    function showLoadingState(message) {
        outputDisplay.innerHTML = `<div class="loading" style="padding: 40px; display:flex; justify-content: center; align-items: center; gap: 8px;"><div class="spinner"></div><span>${message}</span></div>`;
    }

    function showErrorState(message) {
        outputDisplay.innerHTML = `<div class="output-card"><p style="color: red;">Error: ${message}</p></div>`;
    }

    function displayKeywords(keywords) {
        if (!keywords) {
            showErrorState('The model did not return any keywords. Please try again.');
            return;
        }
        let html = '';
        for (const category in keywords) {
            if (keywords.hasOwnProperty(category) && Array.isArray(keywords[category])) {
                html += `
                    <div class="output-card">
                        <h4>${category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</h4>
                        <ul class="output-list">
                            ${keywords[category].map(kw => `<li>${kw}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
        }
        outputDisplay.innerHTML = html;
    }

    function displayHeadlines(headlines) {
        if (!headlines || headlines.length === 0) {
            showErrorState('The model did not return any headlines. Please try again.');
            return;
        }
        outputDisplay.innerHTML = `
            <div class="output-card">
                <h4>Headline Ideas</h4>
                <ul class="output-list">
                    ${headlines.map(h => `<li>${h.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</li>`).join('')}
                </ul>
            </div>
        `;
    }

    function displayAudit(auditResults) {
        if (!auditResults) {
            showErrorState('The model did not return any audit results. Please try again.');
            return;
        }
        // Assuming audit_results is a markdown formatted string
        outputDisplay.innerHTML = `<div class="output-card"><h4>On-Page SEO Audit</h4><div class="output-content">${markdownToHtml(auditResults)}</div></div>`;
    }

    function markdownToHtml(md) {
        // Basic markdown to HTML conversion
        md = md.replace(/^### (.*$)/gim, '<h3>$1</h3>');
        md = md.replace(/^## (.*$)/gim, '<h2>$1</h2>');
        md = md.replace(/^# (.*$)/gim, '<h1>$1</h1>');
        md = md.replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>');
        md = md.replace(/\*(.*)\*/gim, '<em>$1</em>');
        md = md.replace(/^\* (.*$)/gim, '<ul><li>$1</li></ul>');
        md = md.replace(/^\s*\n\*/gim, '<li>');
        md = md.replace(/<\/ul>\n<ul>/gim, '');
        return md.replace(/\n/g, '<br>');
    }

    window.loadSessionIntoView = async function(sessionId) {
        try {
            showLoadingState("Loading session...");
            const response = await fetch(`/api/chat-session/${sessionId}`);
            if (!response.ok) throw new Error('Failed to fetch session data.');

            const session = await response.json();
            seoChatSessionId = session.session_id;

            const userInput = JSON.parse(session.messages[0].content);

            if (session.studio_type === 'SEO_KEYWORDS') {
                document.querySelector('.tab-button[data-tab="keywords"]').click();
                document.getElementById('keyword-topic').value = userInput.topic || '';
                document.getElementById('generateKeywordsBtn').disabled = true;
                displayKeywords(JSON.parse(session.raw_text));
            } else if (session.studio_type === 'SEO_HEADLINES') {
                document.querySelector('.tab-button[data-tab="headlines"]').click();
                document.getElementById('headline-topic').value = userInput.topic || '';
                document.getElementById('generateHeadlinesBtn').disabled = true;
                displayHeadlines(session.raw_text.split('\\n').filter(h => h.trim()));
            }

            if (typeof showNotification === 'function') {
                showNotification('Session loaded successfully!');
            }
            setInputsDisabled(true);
        } catch (error) {
            showErrorState(error.message);
        }
    }
});
</script>
{% endblock %}
