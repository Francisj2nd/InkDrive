{% extends "studio_template.html" %}

{% block title %}Web Copy Studio{% endblock %}

{% block studio_head_css %}
<style>
    /* Custom Tab Styles from Brainstorming Studio */
    .tabs {
        display: flex;
        border-bottom: 1px solid var(--outline);
        margin-bottom: 20px;
    }
    .tab-button {
        padding: 10px 20px;
        cursor: pointer;
        border: none;
        background: none;
        font-family: inherit;
        font-size: 14px;
        font-weight: 500;
        color: var(--on-surface-variant);
        border-bottom: 2px solid transparent;
        margin-bottom: -1px;
    }
    .tab-button.active {
        color: var(--primary-blue);
        border-bottom-color: var(--primary-blue);
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    /* General Studio Styles */
    .output-card {
        background: var(--surface-variant);
        border: 1px solid var(--outline);
        border-radius: 8px;
        padding: 16px;
        margin-top: 16px;
    }
    .output-content {
        white-space: pre-wrap;
    }
    .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid var(--outline);
        border-top: 2px solid var(--primary-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block studio_title %}Web Copy Studio{% endblock %}
{% block studio_description %}Craft foundational, persuasive copy for your website.{% endblock %}

{% block studio_inputs %}
<div class="tabs">
    <button class="tab-button active" data-tab="landing-page">Landing Page</button>
    <button class="tab-button" data-tab="homepage-section">Homepage Section</button>
    <button class="tab-button" data-tab="usp">Value Proposition</button>
</div>

<!-- Landing Page Writer Tab -->
<div id="landing-page" class="tab-content active">
    <div class="form-group"><label for="lp-product-name">Product Name</label><input type="text" id="lp-product-name" class="form-control" placeholder="e.g., Quantum CRM"></div>
    <div class="form-group"><label for="lp-audience">Target Audience</label><input type="text" id="lp-audience" class="form-control" placeholder="e.g., Small business owners"></div>
    <div class="form-group"><label for="lp-goal">Page Goal</label><input type="text" id="lp-goal" class="form-control" placeholder="e.g., Get users to sign up for a free trial"></div>
    <div class="form-group"><label for="lp-features">Features (one per line)</label><textarea id="lp-features" class="form-control" rows="3" placeholder="e.g., AI-powered contact sorting&#10;Automated email follow-ups"></textarea></div>
    <div class="form-group"><label for="lp-pain-point">Primary Pain Point to Solve</label><input type="text" id="lp-pain-point" class="form-control" placeholder="e.g., Wasting time on manual data entry"></div>
    <div class="form-group"><label for="lp-tone">Tone</label><input type="text" id="lp-tone" class="form-control" placeholder="e.g., Professional and efficient"></div>
</div>

<!-- Homepage Section Writer Tab -->
<div id="homepage-section" class="tab-content">
    <div class="form-group"><label for="hs-company-name">Company Name</label><input type="text" id="hs-company-name" class="form-control" placeholder="e.g., Innovate Inc."></div>
    <div class="form-group"><label for="hs-one-liner">Company One-Liner</label><input type="text" id="hs-one-liner" class="form-control" placeholder="e.g., We build software that simplifies your workflow."></div>
    <div class="form-group">
        <label for="hs-section-type">Section to Generate</label>
        <select id="hs-section-type" class="form-control">
            <option value="hero" selected>Hero Section</option>
            <option value="features">Features/Benefits Section</option>
            <option value="how_it_works">How It Works Section</option>
            <option value="faq">FAQ Section</option>
        </select>
    </div>
    <div class="form-group">
        <label for="hs-key-info" id="hs-key-info-label">Key Information for Hero Section</label>
        <textarea id="hs-key-info" class="form-control" rows="3" placeholder="e.g., List the main value proposition and desired call to action."></textarea>
    </div>
</div>

<!-- Value Proposition & USP Generator Tab -->
<div id="usp" class="tab-content">
    <div class="form-group"><label for="usp-product-desc">Product Description</label><textarea id="usp-product-desc" class="form-control" rows="3" placeholder="Describe what your product is and what it does."></textarea></div>
    <div class="form-group"><label for="usp-customer">Target Customer</label><input type="text" id="usp-customer" class="form-control" placeholder="e.g., Freelancers who need simple invoicing."></div>
    <div class="form-group"><label for="usp-differentiators">Key Differentiators</label><textarea id="usp-differentiators" class="form-control" rows="2" placeholder="What makes you unique? e.g., Unbeatable price, lifetime support"></textarea></div>
    <div class="form-group"><label for="usp-competitors">Competitors (Optional)</label><input type="text" id="usp-competitors" class="form-control" placeholder="e.g., FreshBooks, Wave"></div>
</div>

<div style="display: flex; gap: 12px; margin-top: 20px;">
    <button id="newSessionBtn" class="btn btn-secondary">
        <span class="material-symbols-outlined">add</span>
        New Session
    </button>
    <button id="generateBtn" class="btn btn-primary mt-3" style="flex-grow: 1;">
        <span class="material-symbols-outlined">web</span>
        Generate Web Copy
    </button>
</div>
{% endblock %}

{% block studio_output %}
<div id="webcopy-output-display">
    <div class="empty-state">
        <span class="material-symbols-outlined" style="font-size: 48px;">web</span>
        <p>Your generated web copy will appear here.</p>
    </div>
</div>
{% endblock %}

{% block studio_scripts %}
<script>
    const STUDIO_TYPE = 'webcopy';
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generateBtn');
    const outputDisplay = document.getElementById('webcopy-output-display');
    const tabs = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    const sectionTypeSelect = document.getElementById('hs-section-type');
    const keyInfoLabel = document.getElementById('hs-key-info-label');
    const keyInfoTextarea = document.getElementById('hs-key-info');
    let webcopyChatSessionId = null;

    // --- Tab Switching Logic ---
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(tab.dataset.tab).classList.add('active');
        });
    });

    // --- Dynamic UI for Homepage Section Tool ---
    const keyInfoPlaceholders = {
        hero: "Provide the main value proposition and desired calls to action (e.g., 'Sign Up Free', 'Learn More').",
        features: "List 3-5 key features and their primary benefit to the user.",
        how_it_works: "Outline the simple, 3-4 steps a user takes to get value from your product.",
        faq: "List 4-5 common questions a potential customer might have."
    };
    sectionTypeSelect?.addEventListener('change', function() {
        const selectedType = this.value;
        keyInfoLabel.textContent = `Key Information for ${this.options[this.selectedIndex].text}`;
        keyInfoTextarea.placeholder = keyInfoPlaceholders[selectedType] || '';
    });

    // --- Main Generate Function ---
    document.getElementById('newSessionBtn')?.addEventListener('click', startNewSession);

    function setInputsDisabled(disabled) {
        // Landing Page
        document.getElementById('lp-product-name').disabled = disabled;
        document.getElementById('lp-audience').disabled = disabled;
        document.getElementById('lp-goal').disabled = disabled;
        document.getElementById('lp-features').disabled = disabled;
        document.getElementById('lp-pain-point').disabled = disabled;
        document.getElementById('lp-tone').disabled = disabled;

        // Homepage Section
        document.getElementById('hs-company-name').disabled = disabled;
        document.getElementById('hs-one-liner').disabled = disabled;
        document.getElementById('hs-section-type').disabled = disabled;
        document.getElementById('hs-key-info').disabled = disabled;

        // USP
        document.getElementById('usp-product-desc').disabled = disabled;
        document.getElementById('usp-customer').disabled = disabled;
        document.getElementById('usp-differentiators').disabled = disabled;
        document.getElementById('usp-competitors').disabled = disabled;

        generateBtn.disabled = disabled;
    }

    function startNewSession() {
        setInputsDisabled(false);
        // Clear inputs
        document.getElementById('lp-product-name').value = '';
        document.getElementById('lp-audience').value = '';
        document.getElementById('lp-goal').value = '';
        document.getElementById('lp-features').value = '';
        document.getElementById('lp-pain-point').value = '';
        document.getElementById('lp-tone').value = '';

        document.getElementById('hs-company-name').value = '';
        document.getElementById('hs-one-liner').value = '';
        document.getElementById('hs-key-info').value = '';

        document.getElementById('usp-product-desc').value = '';
        document.getElementById('usp-customer').value = '';
        document.getElementById('usp-differentiators').value = '';
        document.getElementById('usp-competitors').value = '';

        outputDisplay.innerHTML = `<div class="empty-state"><span class="material-symbols-outlined" style="font-size: 48px;">web</span><p>Your generated web copy will appear here.</p></div>`;
        webcopyChatSessionId = null;
        if (typeof showNotification === 'function') {
            showNotification('New session started.', 'success');
        }
    }

    if (generateBtn) {
        generateBtn.addEventListener('click', async () => {
            const tool = document.querySelector('.tab-button.active')?.dataset.tab;
            if (!tool) return alert('Error: Could not find active tool.');

            const settings = gatherInputs(tool);
            if (!settings) return alert('Please fill in all required fields for the selected tool.');

            showLoading();
            try {
                const response = await fetch('/api/v1/generate/webcopy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tool, settings, chat_session_id: webcopyChatSessionId })
                });
                const data = await response.json();
                if (response.ok) {
                    webcopyChatSessionId = data.chat_session_id;
                    displayOutput(data.result);
                    if (typeof loadChatHistory === 'function') loadChatHistory(STUDIO_TYPE);
                    setInputsDisabled(true);
                } else {
                    throw new Error(data.error || 'Failed to generate content');
                }
            } catch (error) {
                showError(error.message);
            } finally {
                resetButton();
            }
        });
    }

    function gatherInputs(tool) {
        let settings = {};
        let isValid = true;
        if (tool === 'landing-page') {
            settings.productName = document.getElementById('lp-product-name').value;
            settings.audience = document.getElementById('lp-audience').value;
            settings.goal = document.getElementById('lp-goal').value;
            settings.features = document.getElementById('lp-features').value;
            settings.painPoint = document.getElementById('lp-pain-point').value;
            settings.tone = document.getElementById('lp-tone').value;
            if (!settings.productName || !settings.audience || !settings.goal || !settings.features || !settings.painPoint) isValid = false;
        } else if (tool === 'homepage-section') {
            settings.companyName = document.getElementById('hs-company-name').value;
            settings.oneLiner = document.getElementById('hs-one-liner').value;
            settings.sectionType = document.getElementById('hs-section-type').value;
            settings.keyInfo = document.getElementById('hs-key-info').value;
            if (!settings.companyName || !settings.oneLiner || !settings.keyInfo) isValid = false;
        } else if (tool === 'usp') {
            settings.productDesc = document.getElementById('usp-product-desc').value;
            settings.customer = document.getElementById('usp-customer').value;
            settings.differentiators = document.getElementById('usp-differentiators').value;
            settings.competitors = document.getElementById('usp-competitors').value;
            if (!settings.productDesc || !settings.customer || !settings.differentiators) isValid = false;
        }
        return isValid ? settings : null;
    }

    // --- UI Helper Functions ---
    function showLoading() {
        generateBtn.disabled = true;
        generateBtn.innerHTML = `<span class="material-symbols-outlined">hourglass_top</span> Generating...`;
        outputDisplay.innerHTML = `<div class="loading" style="padding: 40px; display:flex; justify-content: center; align-items: center; gap: 8px;"><div class="spinner"></div><span>Crafting your web copy...</span></div>`;
    }

    function showError(message) {
        outputDisplay.innerHTML = `<div class="output-card" style="color: var(--error);"><p><strong>Error:</strong> ${message}</p></div>`;
    }

    function resetButton() {
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<span class="material-symbols-outlined">web</span> Generate Web Copy';
    }

    function displayOutput(text) {
        if (!text) return showError('The model did not return any content. Please try again.');
        outputDisplay.innerHTML = `<div class="output-card"><pre class="output-content">${text.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</pre></div>`;
    }
});
</script>
{% endblock %}
